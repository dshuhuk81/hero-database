<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ Hero Synergy Tag Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: grid;
      grid-template-columns: 300px 1fr;
      min-height: calc(100vh - 40px);
    }

    .header {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-stats {
      display: flex;
      gap: 30px;
      font-size: 14px;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-header {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-header:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Tag Editor Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 10px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 2px solid #e0e6ed;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .tag-edit-section {
      margin-bottom: 25px;
    }

    .tag-edit-section h3 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      color: #667eea;
      margin-bottom: 15px;
      letter-spacing: 1px;
    }

    .tag-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .tag-input-group input {
      flex: 1;
      padding: 10px;
      border: 1px solid #d0d8e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .tag-input-group button {
      padding: 10px 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .tag-input-group button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .tag-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tag-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f5f7fa;
      border-radius: 6px;
      border: 1px solid #e0e6ed;
    }

    .tag-item-name {
      font-weight: 500;
      color: #333;
      font-family: monospace;
      font-size: 13px;
    }

    .tag-item-actions {
      display: flex;
      gap: 8px;
    }

    .tag-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .tag-btn-edit {
      background: #fff3cd;
      color: #856404;
    }

    .tag-btn-edit:hover {
      background: #ffe69c;
    }

    .tag-btn-delete {
      background: #f8d7da;
      color: #721c24;
    }

    .tag-btn-delete:hover {
      background: #f5c6cb;
    }

    .rename-input-group {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .rename-input-group input {
      flex: 1;
      padding: 8px;
      border: 1px solid #d0d8e0;
      border-radius: 4px;
      font-size: 13px;
    }

    .rename-input-group button {
      padding: 8px 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }

    .rename-input-group button:hover {
      background: #218838;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #e0e6ed;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-badge {
      display: inline-block;
      background: #e0e6ed;
      color: #333;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .sidebar {
      background: #f5f7fa;
      border-right: 1px solid #e0e6ed;
      overflow-y: auto;
      padding: 0;
    }

    .hero-search {
      padding: 15px;
      border-bottom: 1px solid #e0e6ed;
      sticky: top;
      background: white;
    }

    .hero-search input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d0d8e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .hero-list {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .hero-item {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f3f7;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .hero-item:hover {
      background: #f0f3f7;
    }

    .hero-item.active {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }

    .hero-item .hero-name {
      font-size: 13px;
    }

    .hero-item .tag-count {
      font-size: 11px;
      opacity: 0.6;
    }

    .hero-item.active .tag-count {
      opacity: 0.8;
    }

    .main {
      background: white;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .editor {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-height: 100%;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #e0e6ed;
      padding-bottom: 15px;
    }

    .editor-header h2 {
      font-size: 20px;
      color: #333;
    }

    .hero-meta {
      display: flex;
      gap: 20px;
      font-size: 13px;
      color: #666;
    }

    .hero-meta-item {
      display: flex;
      gap: 8px;
    }

    .hero-meta-label {
      font-weight: 600;
      color: #333;
    }

    .tag-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-height: 0;
    }

    .tag-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tag-section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: #667eea;
      letter-spacing: 1px;
    }

    .tag-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      flex: 1;
      overflow-y: auto;
    }

    .tag-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid #d0d8e0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .tag-checkbox:hover {
      background: #f5f7fa;
      border-color: #667eea;
    }

    .tag-checkbox input[type="checkbox"] {
      margin: 0;
      cursor: pointer;
    }

    .tag-checkbox input[type="checkbox"]:checked {
      accent-color: #667eea;
    }

    .tag-checkbox label {
      cursor: pointer;
      margin: 0;
      font-size: 13px;
      user-select: none;
    }

    .tag-checkbox input[type="checkbox"]:checked + label {
      color: #667eea;
      font-weight: 600;
    }

    .buttons {
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid #e0e6ed;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f0f3f7;
      color: #333;
      border: 1px solid #d0d8e0;
    }

    .btn-secondary:hover {
      background: #e0e6ed;
    }

    .status {
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 13px;
      min-height: 20px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .placeholder {
      padding: 40px;
      text-align: center;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 14px;
    }

    .category-team-support {
      background: #e3f2fd;
      border-color: #90caf9;
    }

    .category-enemy-debuff {
      background: #ffe0b2;
      border-color: #ffb74d;
    }

    .category-playstyle {
      background: #f3e5f5;
      border-color: #ce93d8;
    }

    .category-self-buffs {
      background: #e8f5e9;
      border-color: #81c784;
    }

    .category-self-only {
      background: #fff9c4;
      border-color: #fdd835;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }

      .sidebar {
        display: none;
      }

      .hero-search {
        display: none;
      }

      .header {
        flex-wrap: wrap;
        gap: 10px;
      }

      .header-stats {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ Hero Synergy Tag Manager</h1>
      <div class="header-stats">
        <div><strong id="totalHeroes">0</strong> Heroes</div>
        <div><strong id="editedCount">0</strong> Tagged</div>
      </div>
      <div class="header-buttons">
        <button class="btn-header" id="editTagsBtn">üè∑Ô∏è Edit Tags</button>
      </div>
    </div>

    <div class="sidebar">
      <div class="hero-search">
        <input type="text" id="heroSearch" placeholder="Search heroes...">
      </div>
      <div class="hero-list" id="heroList"></div>
    </div>

    <div class="main">
      <div id="editor" class="editor" style="display: none;">
        <div class="editor-header">
          <div>
            <h2 id="editorHeroName">Select a Hero</h2>
            <div class="hero-meta">
              <div class="hero-meta-item">
                <span class="hero-meta-label">Class:</span>
                <span id="editorHeroClass">-</span>
              </div>
            </div>
          </div>
        </div>

        <div class="tag-container">
          <div id="tagsContainer"></div>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="buttons">
          <button class="btn btn-primary" id="saveBtn">üíæ Save Tags</button>
          <button class="btn btn-secondary" id="clearBtn">‚úñÔ∏è Clear All</button>
        </div>
      </div>

      <div class="placeholder" id="placeholder">
        <div class="loading">Loading heroes...</div>
      </div>
    </div>
  </div>

  <!-- Tag Editor Modal -->
  <div class="modal" id="tagEditorModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üè∑Ô∏è Manage Tags</h2>
        <button class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Add New Tag -->
        <div class="tag-edit-section">
          <h3>‚ûï Add New Tag</h3>
          <div class="tag-input-group">
            <input type="text" id="newTagInput" placeholder="Enter new tag name (e.g., NEW_TAG)">
            <button id="addTagBtn">Add Tag</button>
          </div>
        </div>

        <!-- Manage Existing Tags -->
        <div class="tag-edit-section">
          <h3>üìã Existing Tags <span class="modal-badge" id="tagCount">0 Tags</span></h3>
          <div class="tag-list" id="tagList"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="modalCloseBtn2">Close</button>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:3000/api';
    let heroes = [];
    let allTags = [];
    let currentHero = null;
    let tagCategories = {
      'Team Support': [
        'ATK_SPD_UP', 'BUFF_TEAM', 'CC_IMMUNITY_TEAM', 'CDR_TEAM',
        'DAMAGE_REDUCTION_TEAM', 'DEBUFF_CLEANSE_TEAM', 'ENERGY_RESTORE_TEAM', 'HEAL_TEAM', 'SHIELD_TEAM'
      ],
      'Enemy Debuff': [
        'ATK_DOWN', 'ATK_SPD_DOWN', 'BUFF_DISPEL', 'CROWD_CONTROL', 'ENEMY_VULNERABILITY',
        'ENERGY_DRAIN', 'REDUCES_ATTRIBUTES', 'REMOVES_ARMOR', 'TAUNT'
      ],
      'Playstyle': [
        'AREA_DAMAGE_DEALER', 'BASIC_ATTACK_SCALER'
      ],
      'Self Buffs': [
        'ATK_SPEED', 'ATK_UP', 'CC_RESISTANCE', 'DMG_RED', 'DODGE_BUFF',
        'ENERGY_RESTORE', 'GAIN_ARMOR', 'HEAL', 'HEAL_EFFECT_UP', 'HIT_AVOID', 'HP_UP',
        'LIFE_STEAL_UP', 'SHIELD'
      ]
    };

    // Load initial data
    async function init() {
      try {
        console.log('üöÄ Fetching from API:', API);
        
        const tagsRes = await fetch(`${API}/tags`);
        console.log('Tags response status:', tagsRes.status);
        if (!tagsRes.ok) {
          throw new Error(`Tags API responded with ${tagsRes.status}`);
        }
        allTags = await tagsRes.json();
        console.log('‚úÖ Loaded tags:', allTags.length);

        const heroesRes = await fetch(`${API}/heroes`);
        console.log('Heroes response status:', heroesRes.status);
        if (!heroesRes.ok) {
          throw new Error(`Heroes API responded with ${heroesRes.status}`);
        }
        heroes = await heroesRes.json();
        console.log('‚úÖ Loaded heroes:', heroes.length);

        document.getElementById('totalHeroes').textContent = heroes.length;
        renderHeroList();
        renderPlaceholder();
      } catch (err) {
        console.error('‚ùå Failed to load data:', err);
        document.getElementById('placeholder').innerHTML = `<div class="loading" style="color: red;">
          <div>‚ùå Error:</div>
          <div style="font-size: 12px; white-space: pre-wrap; text-align: left;">${err.message}</div>
          <div style="font-size: 11px; margin-top: 10px;">Check browser console (F12)</div>
        </div>`;
      }
    }

    function renderHeroList() {
      const list = document.getElementById('heroList');
      list.innerHTML = heroes.map(h => `
        <div class="hero-item" data-id="${h.id}">
          <div>
            <div class="hero-name">${h.name}</div>
            <div class="tag-count">${h.synergies.length} tags</div>
          </div>
        </div>
      `).join('');

      list.addEventListener('click', (e) => {
        const item = e.target.closest('.hero-item');
        if (item) {
          selectHero(item.dataset.id);
        }
      });

      // Search
      document.getElementById('heroSearch').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.hero-item').forEach(item => {
          const name = item.querySelector('.hero-name').textContent.toLowerCase();
          item.style.display = name.includes(query) ? '' : 'none';
        });
      });
    }

    function selectHero(heroId) {
      currentHero = heroes.find(h => h.id === heroId);
      if (!currentHero) return;

      // Update sidebar
      document.querySelectorAll('.hero-item').forEach(item => {
        item.classList.toggle('active', item.dataset.id === heroId);
      });

      renderEditor();
    }

    function renderEditor() {
      if (!currentHero) return;

      document.getElementById('editorHeroName').textContent = currentHero.name;
      document.getElementById('editorHeroClass').textContent = currentHero.class;
      document.getElementById('editor').style.display = 'flex';
      document.getElementById('placeholder').style.display = 'none';

      const container = document.getElementById('tagsContainer');
      container.innerHTML = '';

      for (const [category, tags] of Object.entries(tagCategories)) {
        const section = document.createElement('div');
        section.className = 'tag-section';

        const title = document.createElement('div');
        title.className = 'tag-section-title';
        title.textContent = category;
        section.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'tag-grid';

        for (const tag of tags) {
          const checkbox = document.createElement('label');
          checkbox.className = 'tag-checkbox';
          const categoryClass = category === 'Team Support' ? 'category-team-support' :
                                category === 'Enemy Debuff' ? 'category-enemy-debuff' :
                                category === 'Playstyle' ? 'category-playstyle' :
                                'category-self-buffs';
          checkbox.classList.add(categoryClass);

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.value = tag;
          input.checked = currentHero.synergies.includes(tag);

          const label = document.createElement('label');
          label.textContent = tag.replace(/_/g, ' ');
          label.style.margin = '0';

          checkbox.appendChild(input);
          checkbox.appendChild(label);
          grid.appendChild(checkbox);
        }

        section.appendChild(grid);
        container.appendChild(section);
      }

      // Button handlers
      document.getElementById('saveBtn').onclick = saveSynergies;
      document.getElementById('clearBtn').onclick = clearSynergies;

      updateEditedCount();
    }

    function getSelectedTags() {
      return Array.from(document.querySelectorAll('#tagsContainer input[type="checkbox"]:checked')).map(cb => cb.value);
    }

    async function saveSynergies() {
      if (!currentHero) return;

      const synergies = getSelectedTags();
      const btn = document.getElementById('saveBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚è≥ Saving...';

      try {
        const res = await fetch(`${API}/heroes/${currentHero.id}/synergies`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ synergies })
        });

        const data = await res.json();

        if (res.ok) {
          // Update local data
          currentHero.synergies = synergies;
          const heroData = heroes.find(h => h.id === currentHero.id);
          if (heroData) heroData.synergies = synergies;
          renderHeroList();
          updateEditedCount();

          showStatus('‚úÖ ' + data.message, 'success');
        } else {
          showStatus('‚ùå Error: ' + data.error, 'error');
        }
      } catch (err) {
        showStatus('‚ùå Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function clearSynergies() {
      document.querySelectorAll('#tagsContainer input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';

      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }

    function updateEditedCount() {
      const count = heroes.filter(h => h.synergies.length > 0).length;
      document.getElementById('editedCount').textContent = count;
    }

    function renderPlaceholder() {
      const placeholder = document.getElementById('placeholder');
      placeholder.innerHTML = '<div class="placeholder"><div style="font-size: 24px; margin-bottom: 10px;">üëà</div><div>Select a hero from the left to edit synergies</div></div>';
    }

    // =====================
    // TAG EDITOR MODAL
    // =====================

    function openTagEditor() {
      document.getElementById('tagEditorModal').classList.add('active');
      renderTagList();
    }

    function closeTagEditor() {
      document.getElementById('tagEditorModal').classList.remove('active');
    }

    function renderTagList() {
      const tagList = document.getElementById('tagList');
      tagList.innerHTML = '';
      
      if (allTags.length === 0) {
        tagList.innerHTML = '<div class="placeholder" style="padding: 20px; color: #999;">No tags found</div>';
        return;
      }

      allTags.forEach((tag, idx) => {
        const item = document.createElement('div');
        item.className = 'tag-item';
        item.innerHTML = `
          <div class="tag-item-name">${tag}</div>
          <div class="tag-item-actions">
            <button class="tag-btn tag-btn-edit" onclick="startRenameTag('${tag}', this.closest('.tag-item'))">üìù Rename</button>
            <button class="tag-btn tag-btn-delete" onclick="deleteTag('${tag}')">üóëÔ∏è Delete</button>
          </div>
        `;
        tagList.appendChild(item);
      });

      document.getElementById('tagCount').textContent = `${allTags.length} Tags`;
    }

    function startRenameTag(oldTag, itemElement) {
      const actionsDiv = itemElement.querySelector('.tag-item-actions');
      actionsDiv.innerHTML = `
        <div class="rename-input-group" style="width: 100%;">
          <input type="text" placeholder="New tag name" value="${oldTag}">
          <button onclick="confirmRenameTag('${oldTag}', this.parentElement.querySelector('input').value)">‚úì</button>
          <button onclick="renderTagList()" style="background: #6c757d;">‚úï</button>
        </div>
      `;
    }

    async function confirmRenameTag(oldTag, newTag) {
      if (!newTag || newTag.trim() === '') {
        showStatus('‚ùå Tag name cannot be empty', 'error');
        return;
      }

      if (newTag === oldTag) {
        renderTagList();
        return;
      }

      try {
        const res = await fetch(`${API}/tags/${oldTag}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newTag: newTag.toUpperCase() })
        });

        const data = await res.json();

        if (res.ok) {
          allTags = data.tags;
          renderTagList();
          renderEditor(); // Refresh hero editor if open
          showStatus('‚úÖ ' + data.message, 'success');
        } else {
          showStatus('‚ùå Error: ' + data.error, 'error');
          renderTagList();
        }
      } catch (err) {
        showStatus('‚ùå Error: ' + err.message, 'error');
        renderTagList();
      }
    }

    async function deleteTag(tag) {
      if (!confirm(`Delete tag "${tag}" from all heroes?`)) return;

      try {
        const res = await fetch(`${API}/tags/${tag}`, {
          method: 'DELETE'
        });

        const data = await res.json();

        if (res.ok) {
          allTags = data.tags;
          renderTagList();
          renderEditor(); // Refresh hero editor if open
          showStatus('‚úÖ ' + data.message, 'success');
        } else {
          showStatus('‚ùå Error: ' + data.error, 'error');
        }
      } catch (err) {
        showStatus('‚ùå Error: ' + err.message, 'error');
      }
    }

    async function addNewTag() {
      const input = document.getElementById('newTagInput');
      const tag = input.value.trim().toUpperCase();

      if (!tag) {
        showStatus('‚ùå Tag name cannot be empty', 'error');
        return;
      }

      if (!/^[A-Z_]+$/.test(tag)) {
        showStatus('‚ùå Tag must contain only uppercase letters and underscores', 'error');
        return;
      }

      try {
        const res = await fetch(`${API}/tags`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tag })
        });

        const data = await res.json();

        if (res.ok) {
          input.value = '';
          allTags = data.tags;
          renderTagList();
          
          // Update tagCategories for editor
          updateTagCategories();
          renderEditor(); // Refresh hero editor if open
          showStatus('‚úÖ ' + data.message, 'success');
        } else {
          showStatus('‚ùå Error: ' + data.error, 'error');
        }
      } catch (err) {
        showStatus('‚ùå Error: ' + err.message, 'error');
      }
    }

    function updateTagCategories() {
      // Add new tags to a "Custom Tags" category
      const customTags = allTags.filter(tag => {
        return !Object.values(tagCategories).flat().includes(tag);
      });

      if (customTags.length > 0) {
        tagCategories['Custom Tags'] = customTags;
      } else if (tagCategories['Custom Tags']) {
        delete tagCategories['Custom Tags'];
      }
    }

    // Modal event listeners
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('editTagsBtn').addEventListener('click', openTagEditor);
      document.getElementById('modalCloseBtn').addEventListener('click', closeTagEditor);
      document.getElementById('modalCloseBtn2').addEventListener('click', closeTagEditor);
      document.getElementById('addTagBtn').addEventListener('click', addNewTag);
      
      document.getElementById('newTagInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addNewTag();
      });

      // Close modal when clicking outside
      document.getElementById('tagEditorModal').addEventListener('click', (e) => {
        if (e.target.id === 'tagEditorModal') closeTagEditor();
      });
    });

    init();
  </script>
</body>
</html>
