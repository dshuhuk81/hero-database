---
import bosses from "../data/bosses.json";
import { getHeroById } from "../data/heroes";
import Sidebar from "../components/Sidebar.astro";
import Footer from "../components/Footer.astro";
import "../styles/compositions.css";
import { keywordTagsForHero } from "../utils/heroTags.js";

// Mechanic counter mapping: boss mechanicTag â†’ hero capabilities
const MECHANIC_COUNTERS = {
  "ENERGY_DRAIN": { heroTags: ["Energy"], classes: ["Support"], description: "Energy sustain" },
  "SILENCE": { heroTags: ["Cleanse"], classes: [], description: "Removes silence" },
  "DAMAGE_REDUCTION_PHASE": { heroTags: [], classes: [], description: "Burst timing" },
  "TARGETS_TOP_DPS": { heroTags: ["Shield", "Ally Heal"], classes: ["Support"], description: "Protects allies" },
  "DOT_ON_TOP_DPS": { heroTags: ["Ally Heal", "Shield"], classes: ["Support"], description: "Sustained healing" },
  "PERCENT_HP_DAMAGE": { heroTags: ["Shield"], classes: ["Tank", "Support"], description: "Damage mitigation" },
  "RAMPING_AURA": { heroTags: [], classes: [], description: "Fast clear" },
  "ATK_SPEED_GLOBAL": { heroTags: [], classes: [], description: "Speed synergy" },
  "CHARGE_ATTACK": { heroTags: ["Control"], classes: [], description: "Interrupts/stuns" },
  "AOE_BURST": { heroTags: [], classes: ["Tank"], description: "Absorbs damage" },
  "STUN": { heroTags: ["Cleanse"], classes: [], description: "Removes stun" },
  "BUFFS_OVER_TIME": { heroTags: ["Anti-Heal"], classes: [], description: "Healing reduction" },
};

function getHeroMechanicCounters(heroId, bossMechanicTags) {
  const hero = getHeroById(heroId);
  if (!hero) return [];
  const heroTags = keywordTagsForHero(hero, { limit: null });
  const heroClass = String(hero?.class || "").toLowerCase();
  const counters = [];
  for (const mechanic of bossMechanicTags) {
    const counter = MECHANIC_COUNTERS[mechanic];
    if (!counter) continue;
    const hasTag = counter.heroTags.some(t => heroTags.includes(t));
    const hasClass = counter.classes.some(c => c.toLowerCase() === heroClass);
    if (hasTag || hasClass) counters.push(counter.description);
  }
  return [...new Set(counters)];
}

function heroName(id) { return getHeroById(id)?.name ?? id; }
function heroImage(id) {
  const img = getHeroById(id)?.image;
  return img?.startsWith("/") ? img : `/${img}`;
}
function factionIcon(faction) {
  return `/icons/factions/${String(faction || "").toLowerCase()}.webp`;
}
function classIcon(heroClass) {
  return `/icons/classes/${String(heroClass || "").toLowerCase()}.webp`;
}

const BOSS_SKILL_ICON_ALIAS = { isthar_vi: "ishtar" };
function bossSkillIcon(bossId, index) {
  const key = BOSS_SKILL_ICON_ALIAS[bossId] || bossId;
  return `/bosses/${key}_skill_${index + 1}.png`;
}
---

<Sidebar />

<section class="boss-page">

  <!-- Boss tabs bar -->
  <div class="boss-tabbar" data-boss-slider>
    {bosses.bosses.map((boss, index) => (
      <button class="boss-tab" type="button" data-boss-tab data-index={index}>
        {boss.name}
      </button>
    ))}
  </div>

  <!-- Slides -->
  <div class="boss-slides" data-boss-slides>
    {bosses.bosses.map((boss, index) => (
      <article class="boss-slide" data-boss-slide data-index={index}>

        <!-- LEFT: cinematic visual column -->
        <div class="boss-visual" style={`--boss-image: url(${boss.image})`}>
          <div class="boss-visual-scrim"></div>
          <div class="boss-identity">
            <p class="boss-kicker">Boss Encounter</p>
            <h2 class="boss-name">{boss.name}</h2>
            <div class="boss-meta">
              <span class="pill">{boss.mode}</span>
              <span class="pill pill-icon">
                <img class="meta-icon" src={factionIcon(boss.faction)} alt={boss.faction} />
                {boss.faction}
              </span>
              <span class="pill pill-icon">
                <img class="meta-icon" src={classIcon(boss.class)} alt={boss.class} />
                {boss.class}
              </span>
              <span class="pill">BP {boss.battlepower}</span>
            </div>
            {boss.summary && <p class="boss-summary">{boss.summary}</p>}
          </div>

          <!-- Prev/Next inside the visual column -->
          <div class="boss-nav-pair">
            <button class="boss-nav boss-nav-left" aria-label="Previous boss" type="button">&#x2039;</button>
            <button class="boss-nav boss-nav-right" aria-label="Next boss" type="button">&#x203A;</button>
          </div>
        </div>

        <!-- RIGHT: info panel -->
        <div class="boss-panel">

          <!-- Mechanics -->
          <div class="panel-section">
            <h3 class="panel-heading">Mechanics</h3>
            <div class="mechanic-list">
              {boss.skills.map((sk, skillIndex) => (
                <div class="mechanic-item">
                  {sk.type !== "Passive" && (
                    <img
                      class="skill-icon"
                      src={bossSkillIcon(boss.id, skillIndex)}
                      alt={`${boss.name} ${sk.name}`}
                      loading="lazy"
                    />
                  )}
                  <div class="mechanic-body">
                    <span class="mechanic-title">
                      {sk.name}
                      <span class="mechanic-type">{sk.type}</span>
                    </span>
                    <p class="mechanic-desc">{sk.description}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <!-- Strategy Notes -->
          {boss.strategyNotes && (
            <div class="panel-section">
              <h3 class="panel-heading">Strategy Notes</h3>
              <p class="strategy-text">{boss.strategyNotes}</p>
            </div>
          )}

          <!-- Recommended Comps -->
          {(boss.recommendedComps || []).length > 0 && (
            <div class="panel-section">
              <h3 class="panel-heading">Recommended Comps</h3>
              <div class="comp-list">
                {(boss.recommendedComps || []).map(comp => {
                  const heroComp = String(comp["hero-comp"] || "")
                    .split(",")
                    .map(e => e.trim())
                    .filter(Boolean);
                  const resolvedHeroes = heroComp.length ? heroComp : (comp.heroes ?? []);
                  const bossMechanics = boss.mechanicTags || [];

                  return (
                    <div class="comp-entry">
                      <div class="comp-entry-header">
                        <span class="comp-label">{comp.label}</span>
                        {comp.reason && <p class="comp-reason">{comp.reason}</p>}
                      </div>
                      <div class="comp-hero-row">
                        {resolvedHeroes.map(id => {
                          const counters = getHeroMechanicCounters(id, bossMechanics);
                          return (
                            <a href={`/heroes/${id}`} class="hero-chip">
                              <img src={heroImage(id)} alt={heroName(id)} />
                              <span class="hero-chip-name">{heroName(id)}</span>
                              {counters.length > 0 && (
                                <div class="chip-badges">
                                  {counters.map(c => (
                                    <span class="badge-counter" title={c}>{c}</span>
                                  ))}
                                </div>
                              )}
                            </a>
                          );
                        })}
                      </div>
                      {comp.notes?.length > 0 && (
                        <ul class="comp-notes">
                          {comp.notes.map(n => <li>{n}</li>)}
                        </ul>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

        </div>
      </article>
    ))}
  </div>
</section>

<script>
  const slides = Array.from(document.querySelectorAll("[data-boss-slide]"));
  const tabs = Array.from(document.querySelectorAll("[data-boss-tab]"));
  const prevBtns = Array.from(document.querySelectorAll(".boss-nav-left"));
  const nextBtns = Array.from(document.querySelectorAll(".boss-nav-right"));
  let currentIndex = 0;

  function updateSlides(index) {
    currentIndex = (index + slides.length) % slides.length;
    slides.forEach((s, i) => s.classList.toggle("is-active", i === currentIndex));
    tabs.forEach((t, i) => t.classList.toggle("is-active", i === currentIndex));
    const activeTab = tabs[currentIndex];
    activeTab?.scrollIntoView({ block: "nearest", inline: "center", behavior: "smooth" });
  }

  if (slides.length) updateSlides(0);

  prevBtns.forEach(b => b.addEventListener("click", () => updateSlides(currentIndex - 1)));
  nextBtns.forEach(b => b.addEventListener("click", () => updateSlides(currentIndex + 1)));
  tabs.forEach(tab => {
    tab.addEventListener("click", () => updateSlides(Number(tab.dataset.index || 0)));
  });
  document.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") updateSlides(currentIndex - 1);
    if (e.key === "ArrowRight") updateSlides(currentIndex + 1);
  });
</script>

<Footer />