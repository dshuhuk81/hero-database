---
import { heroes, getHeroById, statMaxima } from "../../data/heroes";
import SkillCard from "../../components/hero/SkillCard.astro";
import Footer from "../../components/Footer.astro";  
import RatingCard from "../../components/hero/RatingCard.astro";
import HeroCompositions from '../../components/HeroCompositions.astro';

/* STATIC PATHS */
export function getStaticPaths() {
  return heroes.map((hero) => ({
    params: { id: hero.id },
  }));
}

const { id } = Astro.params;
const hero = getHeroById(id);

// ‚úÖ NEU: Mode aus Query ziehen (general|pve|pvp)
const mode = Astro.url.searchParams.get("mode") ?? "general";

const currentHero = await import(`../../data/heroes/${id}.json`);

if (!hero) {
  throw new Error(`Hero with id "${id}" not found`);
}

const PERCENT_STATS = new Set([
  "dodgeRate",
  "hitBonus",
  "critRate",
  "critRes",
  "critDmgBonus",
  "critDmgReduction",
]);

const STAT_LABELS = {
  hp: "HP",
  atk: "ATK",
  armor: "Armor",
  magicRes: "M-Res",
  dodgeRate: "Dodge",
  hitBonus: "Hit",
  critRate: "Crit Rate",
  critRes: "Crit RES",
  critDmgBonus: "Crit DMG",
  critDmgReduction: "Crit Red",
  energy: "Energy",
};
---

<head>
  <meta charset="utf-8" />
</head>

<div class="hero-detail-page">
  <!-- STICKY HEADER -->
  <header class="hero-detail-header">
    <div class="header-inner header-with-back">
      <a href="/" class="back-button">‚Üê Back</a>

      <div class="header-center">
        <h1 class="hero-title">{hero.name}</h1>

        <nav class="hero-tabs">
          <button class="tab active" data-tab="attributes">Attributes</button>
          <button class="tab" data-tab="skills">Skills</button>
          <button class="tab" data-tab="synergies">Compositions<span class="alpha-chip">Alpha</span></button>
        </nav>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="hero-detail-content">
    <!-- TAB: ATTRIBUTES -->
    <div class="tab-content active" data-content="attributes">
      <section class="hero-overview">
        <!-- LEFT -->
        <div>
          <!-- LARGE HERO NAME -->
          <h2 class="hero-name-large">{hero.name}</h2>

          <!-- Description  -->
          {hero.description && (
            <p class="hero-description">
              {hero.description}
            </p>
          )}
          
          <!-- FACTION -->
          <div class="hero-faction">
            <img
              src={`/icons/factions/${hero.faction.toLowerCase()}.webp`}
              alt={hero.faction}
              class="faction-icon"
            />
            <span class="faction-label">{hero.faction}</span>
          </div>

          <!-- IDENTITY CARDS -->
          <div class="hero-identity-cards">
            <div class="identity-card">
              <h4>Class</h4>
              <div class="identity-content">
                <img
                  class="identity-icons"
                  src={`/icons/classes/${hero.class.toLowerCase()}.webp`}
                  alt={hero.class}
                />
                <span>{hero.class}</span>
              </div>
            </div>

            <div class="identity-card">
              <h4>Role</h4>
              <div class="identity-content">
                <img
                  class="identity-icons"
                  src={`/icons/roles/${hero.role.toLowerCase()}.webp`}
                  alt={hero.role}
                />
                <span>{hero.role}</span>
              </div>
            </div>

            <div class="identity-card">
              <h4>Rarity</h4>
              <div class="identity-content rarity-content">
                <svg class="rarity-star" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M12 2l2.9 6.1 6.7.6-5 4.5 1.5 6.6L12 16.8 5.9 19.8 7.4 13.2 2.4 8.7l6.7-.6L12 2z"
                  ></path>
                </svg>
                <span>{hero.rarity}</span>
              </div>
            </div>

            <!-- üî• NEU: Relic Priority -->
            {hero.recommendedRelicLevel !== undefined && (
              <div class="identity-card">
                <h4>Relic Prio</h4>
                <div class="identity-content">
                  <span class={`relic-level relic-level-${hero.recommendedRelicLevel}`}>
                    Level {hero.recommendedRelicLevel}
                  </span>
                </div>
              </div>
            )}
          </div>
        </div>

        <!-- RIGHT -->
        <div class="hero-visual" style={`background-image: url(${hero.image});`}>
        </div>
      </section>

      <!-- STATS -->
      <section class="hero-stats">
        <h2>Base-Stats</h2>

        <div class="stats-grid">
          {Object.entries(STAT_LABELS).map(([key, label]) => (
            <div class="stat-row">
              <span class="stat-label">{label}</span>

              <div class="stat-right">
                <span class="stat-value">
                  <span class="stat-current">
                    {hero.stats[key]}
                    <span class="stat-max"> / {statMaxima[key]}</span>
                  </span>

                  {hero.rankings?.[key] && (
                    <small class="stat-rank">
                      #{hero.rankings[key]}
                    </small>
                  )}
                </span>

                <!-- STAT BAR -->
                <div class="stat-bar">
                  <div
                    class={`stat-bar-fill ${
                      hero.rankings?.[key] === 1
                        ? "rank-1"
                        : hero.rankings?.[key] === 2
                        ? "rank-2"
                        : hero.rankings?.[key] === 3
                        ? "rank-3"
                        : hero.rankings?.[key] <= 10
                        ? "rank-top"
                        : "rank-default"
                    }`}
                    style={`width: ${
                      statMaxima[key]
                        ? Math.min((hero.stats[key] / statMaxima[key]) * 100, 100)
                        : 0
                    }%`}
                  />
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>

      <!-- RATINGS -->
      {hero.ratings && (
        <RatingCard ratings={hero.ratings} />
      )}
    </div>

    <!-- TAB: SKILLS -->
    <div class="tab-content" data-content="skills">
      <section class="hero-skills">
        <h2>Skills</h2>
        
        <!-- Skills -->
        <div class="skills-container">
          {hero.skills && hero.skills.map((skill, index) => (
            <SkillCard
              name={skill.name}
              icon={skill.image || `/skills/${hero.id}_skill_${index + 1}.webp`}
              description={skill.description}
              upgrades={skill.upgrades}
              type={`Skill ${index + 1}`}
              stars={3}
              showGrid={true}
            />
          ))}

          <!-- Relic -->
          {hero.relic && (
            <SkillCard
              name={hero.relic.name}
              icon={hero.relic.image || `/skills/${hero.id}_relic.webp`}
              description={hero.relic.description}
              upgrades={hero.relic.upgrades}
              type="Relic"
              stars={0}
              showGrid={false}
            />
          )}
        </div>
      </section>
    </div>

    <!-- TAB: COMPOSITIONS -->
    <div class="tab-content" data-content="synergies">
      <div class="comp-toolbar">
        <label for="compMode" class="comp-toolbar-label">Mode</label>
        <select id="compMode" class="comp-toolbar-select">
          <option value="general">General</option>
          <option value="pve">PvE</option>
          <option value="pvp">PvP</option>
        </select>
      </div>

      <div class="comp-modes">
        <div class="comp-mode" data-mode="general">
          <HeroCompositions heroId={id} mode="general" />
        </div>

        <div class="comp-mode" data-mode="pve" style="display:none">
          <HeroCompositions heroId={id} mode="pve" />
        </div>

        <div class="comp-mode" data-mode="pvp" style="display:none">
          <HeroCompositions heroId={id} mode="pvp" />
        </div>
      </div>
    </div>
  </main>

  <Footer />
</div>

<style>
.alpha-chip {
  position: absolute;
  top:-6px;
  right: -10px;
  font-size: 8px;
  color: white;
  background-color: red;
  border-radius: 4px;
  padding: 2px 4px;
}
  .comp-toolbar{
  display:flex;
  align-items:center;
  gap:.75rem;
  margin: 0 0 1rem 0;
}
.comp-toolbar-label{
  opacity:.85;
  font-size:.9rem;
}
.comp-toolbar-select{
  padding:.4rem .6rem;
  border-radius:10px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color: inherit;
}
  /* ‚úÖ NEW: Mode bar styling */
  .comp-mode-bar{
    display:flex;
    gap:.75rem;
    align-items:center;
    margin: 0 0 1rem 0;
    padding: .75rem 1rem;
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 12px;
    background: rgba(0,0,0,.18);
  }
  .comp-mode-bar label{
    font-weight: 700;
    opacity: .9;
  }
  .comp-mode-bar select{
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    color: #e6e6eb;
    padding: .4rem .6rem;
    border-radius: 10px;
    outline: none;
  }

  /* ===============================
     TAB CONTENT
     =============================== */
  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* ===============================
     STAT BARS
     =============================== */

  .stat-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .stat-right {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  /* Hintergrund */
  .stat-bar {
    height: 6px;
    width: 100%;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 999px;
    overflow: hidden;
  }

  /* F√ºllung */
  .stat-bar-fill {
    height: 100%;
    border-radius: inherit;
    background: linear-gradient(90deg, #facc15, #f59e0b);
    box-shadow: 0 0 10px rgba(250, 204, 21, 0.6);
    transition: width 0.4s ease;
  }
  
  /* Rank 1 ‚Äì Gold */
  .stat-bar-fill.rank-1 {
    background: linear-gradient(90deg, #facc15, #fde68a);
    box-shadow: 0 0 10px rgba(250, 204, 21, 0.8);
  }

  /* Rank 2 ‚Äì Silber */
  .stat-bar-fill.rank-2 {
    background: linear-gradient(90deg, #e5e7eb, #f9fafb);
  }

  /* Rank 3 ‚Äì Bronze */
  .stat-bar-fill.rank-3 {
    background: linear-gradient(90deg, #f59e0b, #fcd34d);
  }

  /* Top 10 ‚Äì Blau/Violett */
  .stat-bar-fill.rank-top {
    background: linear-gradient(90deg, #818cf8, #a5b4fc);
  }

  /* ===============================
     HERO DESCRIPTION
     =============================== */
  .hero-description {
    max-width: 560px;
    margin: 0px 0 24px;
    padding: 0;
    font-size: 0.95rem;
    line-height: 1.55;
    color: rgba(230, 230, 235, 0.75);
    text-wrap: pretty;
  }
  
  /* ===============================
     STAT HIGHLIGHTING
     =============================== */
  .stat-max {
    margin-left: 6px;
    font-size: 0.7rem;
    opacity: 0.6;
  }

  .stat-value {
    display: flex;
    align-items: center;
    width: 100%;
    gap: 6px;
  }

  .stat-current {
    white-space: nowrap;
  }

  .stat-rank {
    margin-left: auto;
    font-size: 0.7rem;
    opacity: 0.75;
  }

  /* Top 1 */
  .stat-rank.rank-1 {
    color: #facc15;
    text-shadow: 0 0 6px rgba(250, 204, 21, 0.8);
    font-weight: 700;
  }

  /* Top 2 */
  .stat-rank.rank-2 {
    color: #e5e7eb;
    text-shadow: 0 0 6px rgba(229, 231, 235, 0.7);
  }

  /* Top 3 */
  .stat-rank.rank-3 {
    color: #f59e0b;
    text-shadow: 0 0 6px rgba(245, 158, 11, 0.7);
  }

  /* Optional: Top 10 */
  .stat-rank.rank-top {
    color: #a5b4fc;
  }

  .identity-icons {
    height: 24px;
    width: 24px;
  }
  
  html,
  body {
    margin: 0;
    padding: 0;
    min-height: 100%;
    background: radial-gradient(
        ellipse at 30% -10%,
        rgba(120, 90, 200, 0.15),
        transparent 60%
      ),
      radial-gradient(
        ellipse at 80% 20%,
        rgba(255, 215, 100, 0.08),
        transparent 55%
      ),
      linear-gradient(to bottom, #0d0b10, #07060c);
    color: #e6e6eb;
    font-family: Spectral, ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji",
      "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
  }

  /* PAGE */
  .hero-detail-page {
    min-height: 100vh;
  }

  .rarity-stars {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .rarity-star {
    width: 24px;
    height: 24px;
    fill: #facc15;
    filter: drop-shadow(0 0 6px rgba(250, 204, 21, 0.6));
  }

  .rarity-label {
    margin-left: 8px;
    font-size: 0.85rem;
    font-weight: 500;
  }

  /* HEADER */
  .hero-detail-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10, 10, 16, 0.7);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .header-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 18px 24px 14px;
  }

  .header-with-back {
    position: relative;
  }
  
  .identity-card h4 {
    -webkit-font-smoothing: antialiased;
    box-sizing: border-box;
    color: #ffffff;
    columns: auto;
    font-family: "Source Sans Pro", ui-sans-serif, system-ui, sans-serif,
      "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
      "Noto Color Emoji";
    font-size: 14px;
    font-weight: 700;
    line-height: 20px;
    text-align: center;
    text-transform: uppercase;
    text-wrap: nowrap;
    white-space: nowrap;
    margin: 0;
    padding: 0;
  }

  .identity-content span {
    -webkit-font-smoothing: antialiased;
    box-sizing: border-box;
    color: #ffffff;
    columns: auto;
    font-family: Spectral, ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji",
      "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-size: 14px;
    line-height: 20px;
    padding: 0px 0px 0px;
    text-align: center;
    text-transform: capitalize;
    text-wrap: nowrap;
    white-space: nowrap;
  }

  .back-button {
    position: absolute;
    left: 24px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
  }

  /* HEADER CENTER */
  .header-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .hero-title {
    margin: 0;
    font-size: 1.9rem;
  }

  /* TABS */
  .hero-tabs {
    display: flex;
    gap: 26px;
  }

  .tab {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    padding: 8px 12px;
    font-size: 1rem;
    transition: all 0.2s ease;
    position: relative;
  }

  .tab.active {
    color: #fff;
    border-bottom: 2px solid #facc15;
  }

  /* CONTENT */
  .hero-detail-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 56px 24px 80px;
  }

  /* OVERVIEW */
  .hero-overview {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
  }

  /* LARGE NAME */
  .hero-name-large {
    font-size: 72px;
    line-height: 1.05;
    font-weight: 600;
    padding: 48px 0 24px 0;
    margin: 0;
  }

  /* FACTION */
  .hero-faction {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 18px;
  }

  /* IDENTITY CARDS */
  .hero-identity-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
  }

  .identity-card {
    background-color: #00000040;
    border: 1px solid #ffffff33;
    border-radius: 12px;
    box-sizing: border-box;
    columns: auto;
    padding: 8px;
  }

  /* IMAGE HERO VISUAL */
  .hero-visual {
    height: 420px;
    border-radius: 18px;
    background-size: cover;
    background-position: center 30%;
    background-repeat: no-repeat;
    overflow: hidden;
  }

  /* Faction Label */
  .faction-label {
    -webkit-font-smoothing: antialiased;
    box-sizing: border-box;
    color: #ffffff;
    columns: auto;
    font-family: Spectral, ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji",
      "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-size: 24px;
    line-height: 32px;
  }
  
  .faction-icon {
    width: 48px;
    height: 48px;
  }

  /* STATS */
  .hero-stats {
    margin-top: 64px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
  }

  .identity-content {
    align-items: center;
    border-radius: 12px;
    box-sizing: border-box;
    columns: auto;
    display: flex;
    gap: 4px;
    justify-content: center;
    padding: 8px;
  }

  /* ===============================
     üî• RELIC LEVEL STYLING - VERBESSERT
     =============================== */
  .relic-level {
    font-weight: 700;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.8rem;
    text-transform: none;
    letter-spacing: 0.3px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    display: inline-block;
    min-width: 80px;
    text-align: center;
  }

  .relic-level-30 {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #1a1a1a;
    font-weight: 800;
    box-shadow: 
      0 0 12px rgba(251, 191, 36, 0.6), 
      0 2px 8px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
    border: 1px solid rgba(245, 158, 11, 0.8);
  }

  .relic-level-20 {
    background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
    color: #ffffff;
    box-shadow: 
      0 0 10px rgba(129, 140, 248, 0.5),
      0 2px 8px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(99, 102, 241, 0.6);
  }

  .relic-level-10 {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #ffffff;
    box-shadow: 
      0 0 8px rgba(16, 185, 129, 0.5),
      0 2px 8px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(5, 150, 105, 0.6);
  }

  .relic-level-1 {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .relic-level-0 {
    background: rgba(255, 255, 255, 0.05);
    color: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .identity-card:has(.relic-level) {
    transition: transform 0.2s ease;
  }

  .identity-card:has(.relic-level):hover {
    transform: translateY(-2px);
  }

  .identity-card:has(.relic-level-30):hover {
    box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);
  }

  .identity-card:has(.relic-level-20):hover {
    box-shadow: 0 4px 16px rgba(129, 140, 248, 0.3);
  }

  .identity-card:has(.relic-level-10):hover {
    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
  }

  /* SKILLS SECTION */
  .hero-skills {
    margin-top: 24px;
  }

  .hero-skills h2 {
    margin-bottom: 1.5rem;
  }

  .skills-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  @media (max-width: 1200px) {
    .skills-container {
      gap: 0.75rem;
    }
    
    .hero-identity-cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .skills-container {
      flex-direction: column;
    }
    
    .hero-overview {
      grid-template-columns: 1fr;
    }
    
    .hero-name-large {
      font-size: 48px;
    }
  }
</style>

<script>
  // ‚úÖ Hash-based Tab Switching (survives reloads)
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');

  function setActiveTab(target) {
    if (!target) return;

    tabs.forEach(t => t.classList.remove('active'));
    contents.forEach(c => c.classList.remove('active'));

    const btn = document.querySelector(`.tab[data-tab="${target}"]`);
    const panel = document.querySelector(`.tab-content[data-content="${target}"]`);

    if (btn) btn.classList.add('active');
    if (panel) panel.classList.add('active');
  }

  // On load: use hash if present
  const initial = (location.hash || '').replace('#', '');
  if (initial) setActiveTab(initial);

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.getAttribute('data-tab');
      // persist in URL
      if (target) location.hash = target;
      setActiveTab(target);
    });
  });

  // ‚úÖ Mode Select: navigate to ?mode=...#synergies (keeps correct tab)
  const sel = document.getElementById('compMode');
  if (sel) {
    sel.addEventListener('change', () => {
      const url = new URL(window.location.href);
      url.searchParams.set('mode', sel.value);
      url.hash = 'synergies';
      window.location.href = url.toString();
    });
  }
  
  // --- Composition Mode Switching (no reload) ---
  const modeSelect = document.getElementById("compMode");
  const modePanels = document.querySelectorAll(".comp-mode[data-mode]");

  function setMode(mode) {
    modePanels.forEach(p => {
      p.style.display = (p.getAttribute("data-mode") === mode) ? "block" : "none";
    });
    if (modeSelect) modeSelect.value = mode;

    // persist without reload
    try { localStorage.setItem("heroCompMode", mode); } catch {}
  }

  // initial mode (localStorage -> fallback general)
  let initialMode = "general";
  try {
    const saved = localStorage.getItem("heroCompMode");
    if (saved && ["general","pve","pvp"].includes(saved)) initialMode = saved;
  } catch {}

  setMode(initialMode);

  if (modeSelect) {
    modeSelect.addEventListener("change", (e) => {
      const v = e.target.value;
      if (["general","pve","pvp"].includes(v)) setMode(v);
    });
  }

</script>