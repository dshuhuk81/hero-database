---
// src/pages/tierlist.astro
import Sidebar from "../components/Sidebar.astro";
import Footer from "../components/Footer.astro";
import { heroes } from "../data/heroes";
import Filter from "../components/filter.astro";

// Alphabetisch sortiert als Default
const sortedHeroes = [...heroes].sort((a, b) =>
  a.name.localeCompare(b.name, "en", { sensitivity: "base" })
);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tier List - Hero Database</title>
  </head>

  <body>
    <Sidebar />
    
    <div class="page-wrapper">
      <!-- HERO HEADER
      <section class="hero-header"></section> -->

      <h1 class="title">Hero Tier List</h1>

      <div class="content-wrapper">
        <Filter />
        

        <!-- RESULTS COUNTER -->
        <div class="resultcontent">
          <p id="heroCounter" class="hero-counter">0 Heroes shown</p>

          <!-- TIER TABLE -->
          <!-- FIX: Zwei-Wrapper-Lösung für sticky thead + overflow-x -->
          <div class="table-scroll-x">
            <div class="table-inner">
              <table class="tier-table" id="tierTable">
                <thead>
                  <tr>
                    <th class="sortable" data-sort="name">
                      Hero
                      <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable" data-sort="overall">
                      Overall
                      <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable" data-sort="grimSurge">
                      Grim Surge
                      <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable" data-sort="delusionsDen">
                      Delusions Den
                      <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable" data-sort="torrentRift">
                      Torrent Rift
                      <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable" data-sort="pvp">
                      PvP
                      <span class="sort-indicator"></span>
                    </th>
                  </tr>
                </thead>
                <tbody id="tierTableBody">
                  {sortedHeroes.map(hero => (
                    <tr 
                      class="hero-row"
                      data-name={hero.name.toLowerCase()}
                      data-class={hero.class.toLowerCase()}
                      data-role={hero.role.toLowerCase()}
                      data-rarity={hero.rarity.toLowerCase()}
                      data-overall={hero.ratings?.overall || 'N/A'}
                      data-grimsurge={hero.ratings?.grimSurge || 'N/A'}
                      data-delusionsden={hero.ratings?.delusionsDen || 'N/A'}
                      data-torrentrift={hero.ratings?.torrentRift || 'N/A'}
                      data-pvp={hero.ratings?.pvp || 'N/A'}
                    >
                      <td class="hero-cell">
                        <a href={`/heroes/${hero.id}`} class="hero-link">
                          <img src={hero.image} alt={hero.name} class="hero-avatar" />
                          <span class="hero-name">{hero.name}</span>
                        </a>
                      </td>
                      <td class="rating-cell">
                        <span class={`rating-badge rating-${hero.ratings?.overall?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.overall || 'N/A'}
                        </span>
                      </td>
                      <td class="rating-cell">
                        <span class={`rating-badge rating-${hero.ratings?.grimSurge?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.grimSurge || 'N/A'}
                        </span>
                      </td>
                      <td class="rating-cell">
                        <span class={`rating-badge rating-${hero.ratings?.delusionsDen?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.delusionsDen || 'N/A'}
                        </span>
                      </td>
                      <td class="rating-cell">
                        <span class={`rating-badge rating-${hero.ratings?.torrentRift?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.torrentRift || 'N/A'}
                        </span>
                      </td>
                      <td class="rating-cell">
                        <span class={`rating-badge rating-${hero.ratings?.pvp?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.pvp || 'N/A'}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <Footer />
    </div>

    <style>
      /* BASE */
      html, body {
        margin: 0;
        padding: 0;
        font-family: "Spectral", "Roboto", system-ui, sans-serif;
        background:
          radial-gradient(ellipse at 30% -10%, rgba(120,90,200,0.15), transparent 60%),
          radial-gradient(ellipse at 80% 20%, rgba(255,215,100,0.08), transparent 55%),
          linear-gradient(to bottom, #0d0b10, #07060c);
        color: #e6e6eb;
      }

      /* PAGE WRAPPER */
      .page-wrapper {
        margin-left: 96px;
      }

      /* HERO HEADER */
      .hero-header {
        height: 360px;
        background-image: url("/bg.jpg");
        background-size: cover;
        background-position: center 150%;
        background-attachment: fixed;
        position: relative;
      }

      .hero-header::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,0.35)),
          linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.45));
      }

      /* TITLE */
      .title {
        text-align: center;
        margin: 32px 0;
        font-weight: 600;
        font-size: 2.5rem;
      }

      /* CONTENT WRAPPER */
      .content-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 16px;
      }

      /* FILTERS (kopiert von index.astro) */
      .filters {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 24px;
        background: linear-gradient(to bottom, rgba(35, 32, 48, 0.85), rgba(18, 16, 26, 0.95));
        backdrop-filter: blur(14px);
        padding: 18px 28px;
        border-radius: 18px;
        box-shadow:
          inset 0 1px 0 rgba(255,255,255,0.08),
          inset 0 -1px 0 rgba(0,0,0,0.6),
          0 20px 50px rgba(0,0,0,0.75);
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
      }

      .filter-label {
        font-weight: 600;
        opacity: 0.85;
      }

      .search-input {
        min-width: 280px;
        height: 32px;
        padding: 6px 10px;
        border-radius: 6px;
        color: #fff;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.2);
      }

      /* CHIPS */
      .chip {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.15s;
      }

      .chip:hover {
        opacity: 1;
        transform: translateY(-1px);
      }

      .chip.active {
        opacity: 1;
      }

      .class-chip img, .role-chip img {
        width: 36px;
        height: 36px;
        filter: grayscale(100%) brightness(1.2);
      }

      .class-chip.active img, .role-chip.active img {
        filter: brightness(1.4);
      }

      /* RARITY STARS */
      .rarity-star {
        width: 28px;
        height: 28px;
        fill: none;
        stroke: currentColor;
        stroke-width: 1.2;
        transition: fill 0.2s ease, filter 0.2s ease, transform 0.15s ease;
      }

      .rarity-chip.common { color: #4ade80; }
      .rarity-chip.epic { color: #a855f7; }
      .rarity-chip.legendary { color: #facc15; }

      .rarity-chip.active .rarity-star {
        fill: currentColor;
        opacity: 1;
        filter: drop-shadow(0 0 6px currentColor) drop-shadow(0 0 12px rgba(255,255,255,0.15));
      }

      .rarity-chip:hover .rarity-star {
        fill: currentColor;
        opacity: 0.4;
      }

      /* RESET BUTTON */
      .reset-button {
        height: 36px;
        padding: 0 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 500;
        color: #e6e6eb;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 999px;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
      }

      .reset-button:hover {
        background: rgba(255, 255, 255, 0.14);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-1px);
      }

      /* HERO COUNTER */
      .hero-counter {
        margin: 24px 0 16px;
        text-align: center;
        font-size: 1.125rem;
      }

      /* TABLE - FIX: Zwei-Wrapper statt einem */
      .table-scroll-x {
        overflow-x: auto;
        overflow-y: visible;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .table-inner {
        min-width: 600px;
        background: rgba(0, 0, 0, 0.2);
      }

      .tier-table {
        width: 100%;
        border-collapse: collapse;
      }

      /* TABLE HEADER - sticky funktioniert jetzt */
      thead th {
        background: #1a1720;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.15);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      thead th.sortable {
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
      }

      thead th.sortable:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      /* SORT INDICATOR */
      .sort-indicator {
        display: inline-block;
        margin-left: 8px;
        opacity: 0.3;
      }

      .sort-indicator::after {
        content: "⇅";
      }

      th.sort-asc .sort-indicator::after {
        content: "↑";
        opacity: 1;
        color: #facc15;
      }

      th.sort-desc .sort-indicator::after {
        content: "↓";
        opacity: 1;
        color: #facc15;
      }

      /* TABLE ROWS */
      .hero-row {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
      }

      .hero-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      /* HERO CELL */
      .hero-cell {
        padding: 12px;
      }

      .hero-link {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: inherit;
        transition: color 0.2s ease;
      }

      .hero-link:hover {
        color: #facc15;
      }

      .hero-avatar {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .hero-name {
        font-weight: 500;
        font-size: 1rem;
      }

      /* RATING CELL */
      .rating-cell {
        padding: 12px;
        text-align: center;
      }

      .rating-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.95rem;
        min-width: 50px;
        text-align: center;
      }

      /* RATING COLORS */
      .rating-sss {
        background: linear-gradient(135deg, #ff6b6b, #ff8787);
        color: #fff;
        box-shadow: 0 0 12px rgba(255, 107, 107, 0.4);
      }

      .rating-ss {
        background: linear-gradient(135deg, #ffd93d, #ffe66d);
        color: #1a1a1a;
        box-shadow: 0 0 12px rgba(255, 217, 61, 0.4);
      }

      .rating-s {
        background: linear-gradient(135deg, #a8e6cf, #c4f0d9);
        color: #1a1a1a;
        box-shadow: 0 0 12px rgba(168, 230, 207, 0.4);
      }

      .rating-a {
        background: linear-gradient(135deg, #74b9ff, #a29bfe);
        color: #fff;
      }

      .rating-b {
        background: linear-gradient(135deg, #dfe6e9, #b2bec3);
        color: #2d3436;
      }

      .rating-c {
        background: linear-gradient(135deg, #636e72, #7f8c8d);
        color: #fff;
      }

      .rating-na {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(230, 230, 235, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* RESPONSIVE */
      @media (max-width: 768px) {
        .page-wrapper {
          margin-left: 0;
          margin-bottom: 64px;
        }

        .title {
          font-size: 1.75rem;
        }

        .tier-table {
          font-size: 0.875rem;
        }

        thead th {
          padding: 10px 8px;
          font-size: 0.85rem;
        }

        .hero-avatar {
          width: 40px;
          height: 40px;
        }

        .rating-badge {
          padding: 4px 10px;
          font-size: 0.85rem;
          min-width: 40px;
        }
      }
      
        /* ===============================
        RARITY BORDERS & GLOW
        =============================== */

        /* Hero Avatar mit Rarity-Border */
        .hero-avatar {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        }

        /* Common */
        [data-rarity="common"] .hero-avatar {
        border-color: rgba(74, 222, 128, 0.55);
        }

        /* Epic */
        [data-rarity="epic"] .hero-avatar {
        border-color: rgba(168, 85, 247, 0.6);
        }

        /* Legendary */
        [data-rarity="legendary"] .hero-avatar {
        border-color: rgba(250, 204, 21, 0.75);
        }

        /* GLOW EFFECT on Hover*/
        .hero-row {
        position: relative;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
        } 
        /*      
        .hero-row::before {
        content: "";
        position: absolute;
        inset: -4px;
        border-radius: 8px;
        opacity: 0;
        filter: blur(12px);
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: -1;
        } */

        /* Common Glow */
        [data-rarity="common"].hero-row::before {
        background: radial-gradient(
        circle at 50% 50%,
        rgba(74, 222, 128, 0.4),
        transparent 60%
        );
        }

        /* Epic Glow */
        [data-rarity="epic"].hero-row::before {
        background: radial-gradient(
        circle at 50% 50%,
        rgba(168, 85, 247, 0.5),
        transparent 60%
        );
        }

        /* Legendary Glow */
        [data-rarity="legendary"].hero-row::before {
        background: radial-gradient(
        circle at 50% 50%,
        rgba(250, 204, 21, 0.6),
        transparent 60%
        );
        }

        /* Show Glow on Hover */
        .hero-row:hover::before {
        opacity: 1;
        }

        /* Legendary: Permanent subtle Glow */
        [data-rarity="legendary"].hero-row::before {
        opacity: 0.3;
        }

        [data-rarity="legendary"].hero-row:hover::before {
        opacity: 0.8;
        }

        /* Avatar Glow on Hover */
        .hero-row:hover .hero-avatar {
        box-shadow: 0 0 16px currentColor;
        transform: scale(1.05);
        }

        [data-rarity="common"]:hover .hero-avatar {
        box-shadow: 0 0 16px rgba(74, 222, 128, 0.6);
        }

        [data-rarity="epic"]:hover .hero-avatar {
        box-shadow: 0 0 16px rgba(168, 85, 247, 0.6);
        }

        [data-rarity="legendary"]:hover .hero-avatar {
        box-shadow: 0 0 20px rgba(250, 204, 21, 0.8);
        }
    </style>

    <script>
      // TIER RANKING ORDER
      const TIER_ORDER: Record<string, number> = {
        'SSS': 7,
        'SS': 6,
        'S': 5,
        'A': 4,
        'B': 3,
        'C': 2,
        'N/A': 1
      };

      document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("searchInput") as HTMLInputElement;
        const resetButton = document.getElementById("resetFilters") as HTMLButtonElement;
        const heroCounter = document.getElementById("heroCounter") as HTMLParagraphElement;
        const tableBody = document.getElementById("tierTableBody") as HTMLTableSectionElement;
        
        const roleChips = document.querySelectorAll(".role-chip");
        const classChips = document.querySelectorAll(".class-chip");
        const rarityChips = document.querySelectorAll(".rarity-chip");
        const sortableHeaders = document.querySelectorAll(".sortable");
        
        let activeRoles = new Set<string>();
        let activeClasses = new Set<string>();
        let activeRarities = new Set<string>();
        let currentSort = { column: 'name', direction: 'asc' };

        // FILTER FUNCTION
        function applyFilters() {
          const query = (searchInput?.value || "").toLowerCase();
          const rows = tableBody.querySelectorAll(".hero-row") as NodeListOf<HTMLTableRowElement>;
          let visible = 0;

          rows.forEach(row => {
            const name = row.dataset.name || '';
            const cls = row.dataset.class || '';
            const role = row.dataset.role || '';
            const rarity = row.dataset.rarity || '';

            const matchesSearch = !query || name.includes(query) || cls.includes(query) || role.includes(query);
            const matchesClass = activeClasses.size === 0 || activeClasses.has(cls);
            const matchesRole = activeRoles.size === 0 || activeRoles.has(role);
            const matchesRarity = activeRarities.size === 0 || activeRarities.has(rarity);

            const show = matchesSearch && matchesClass && matchesRole && matchesRarity;

            row.style.display = show ? "" : "none";
            if (show) visible++;
          });

          if (heroCounter) {
            heroCounter.textContent = visible === 1 ? "1 Hero shown" : `${visible} Heroes shown`;
          }
        }

        // SORT FUNCTION
        function sortTable(column: string) {
          const rows = Array.from(tableBody.querySelectorAll(".hero-row")) as HTMLTableRowElement[];
          
          // Toggle direction
          if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
          }

          // Sort rows
          rows.sort((a, b) => {
            let aVal: string | number = '';
            let bVal: string | number = '';

            if (column === 'name') {
              aVal = a.dataset.name || '';
              bVal = b.dataset.name || '';
              return currentSort.direction === 'asc' 
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
            } else {
              // Rating columns
              const dataKey = column.toLowerCase().replace(/([A-Z])/g, (m) => m.toLowerCase());
              aVal = TIER_ORDER[(a.dataset[dataKey] as string)?.toUpperCase() || 'N/A'] || 0;
              bVal = TIER_ORDER[(b.dataset[dataKey] as string)?.toUpperCase() || 'N/A'] || 0;
              
              return currentSort.direction === 'asc' 
                ? aVal - bVal
                : bVal - aVal;
            }
          });

          // Re-append rows
          rows.forEach(row => tableBody.appendChild(row));

          // Update header indicators
          sortableHeaders.forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.getAttribute('data-sort') === column) {
              th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
          });

          applyFilters();
        }

        // EVENT LISTENERS
        searchInput?.addEventListener("input", applyFilters);

        classChips.forEach(chip => {
          chip.addEventListener("click", () => {
            const c = (chip as HTMLElement).dataset.class || '';
            chip.classList.toggle("active");
            activeClasses.has(c) ? activeClasses.delete(c) : activeClasses.add(c);
            applyFilters();
          });
        });

        roleChips.forEach(chip => {
          chip.addEventListener("click", () => {
            const r = (chip as HTMLElement).dataset.role || '';
            chip.classList.toggle("active");
            activeRoles.has(r) ? activeRoles.delete(r) : activeRoles.add(r);
            applyFilters();
          });
        });

        rarityChips.forEach(chip => {
          chip.addEventListener("click", () => {
            const r = (chip as HTMLElement).dataset.rarity || '';
            chip.classList.toggle("active");
            activeRarities.has(r) ? activeRarities.delete(r) : activeRarities.add(r);
            applyFilters();
          });
        });

        sortableHeaders.forEach(th => {
          th.addEventListener("click", () => {
            const column = th.getAttribute('data-sort');
            if (column) sortTable(column);
          });
        });

        resetButton?.addEventListener("click", () => {
          if (searchInput) searchInput.value = "";
          activeClasses.clear();
          activeRarities.clear();
          activeRoles.clear();
          document.querySelectorAll(".chip.active").forEach(c => c.classList.remove("active"));
          sortTable('name'); // Reset to default sort
        });

        applyFilters();
      });
    </script>
  </body>
</html>