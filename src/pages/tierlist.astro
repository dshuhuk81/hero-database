---
// src/pages/tierlist.astro
import Sidebar from "../components/Sidebar.astro";
import Footer from "../components/Footer.astro";
import { heroes } from "../data/heroes";
import Filter from "../components/filter.astro";

const sortedHeroes = [...heroes].sort((a, b) =>
  a.name.localeCompare(b.name, "en", { sensitivity: "base" })
);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tier List - Hero Database</title>
  </head>

  <body>
    <Sidebar />
    
    <div class="page-wrapper">
      <h1 class="title">Hero Tier List</h1>

      <div class="content-wrapper">
        <Filter />

        <div class="resultcontent">
          <p id="heroCounter" class="hero-counter">0 Heroes shown</p>

          <div class="table-wrapper">

            <!-- STICKY HEADER (eigener div, außerhalb des scroll-containers) -->
            <div class="table-header-sticky">
              <table class="tier-table tier-table--header">
                <thead>
                  <tr>
                    <th class="sortable col-hero" data-sort="name">
                      Hero <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-rating" data-sort="overall">
                      Overall <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-rating" data-sort="grimSurge">
                      Grim Surge <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-rating" data-sort="delusionsDen">
                      Delusions Den <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-rating" data-sort="torrentRift">
                      Torrent Rift <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-rating" data-sort="pvp">
                      PvP <span class="sort-indicator"></span>
                    </th>
                  </tr>
                </thead>
              </table>
            </div>

            <!-- SCROLLBARER BODY -->
            <div class="table-scroll">
              <table class="tier-table tier-table--body" id="tierTable">
                <tbody id="tierTableBody">
                  {sortedHeroes.map(hero => (
                    <tr 
                      class="hero-row"
                      data-name={hero.name.toLowerCase()}
                      data-class={hero.class.toLowerCase()}
                      data-role={hero.role.toLowerCase()}
                      data-rarity={hero.rarity.toLowerCase()}
                      data-faction={hero.faction.toLowerCase()}
                      data-overall={hero.ratings?.overall || 'N/A'}
                      data-grimsurge={hero.ratings?.grimSurge || 'N/A'}
                      data-delusionsden={hero.ratings?.delusionsDen || 'N/A'}
                      data-torrentrift={hero.ratings?.torrentRift || 'N/A'}
                      data-pvp={hero.ratings?.pvp || 'N/A'}
                    >
                      <td class="hero-cell col-hero">
                        <a href={`/heroes/${hero.id}`} class="hero-link">
                          <img src={hero.image} alt={hero.name} class="hero-avatar" />
                          <span class="hero-name">{hero.name}</span>
                        </a>
                      </td>
                      <td class="rating-cell col-rating">
                        <span class={`rating-badge rating-${hero.ratings?.overall?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.overall || 'N/A'}
                        </span>
                      </td>
                      <td class="rating-cell col-rating">
                        <span class={`rating-badge rating-${hero.ratings?.grimSurge?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.grimSurge || 'N/A'}
                        </span>
                      </td>
                      <td class="rating-cell col-rating">
                        <span class={`rating-badge rating-${hero.ratings?.delusionsDen?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.delusionsDen || 'N/A'}
                        </span>
                      </td>
                      <td class="rating-cell col-rating">
                        <span class={`rating-badge rating-${hero.ratings?.torrentRift?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.torrentRift || 'N/A'}
                        </span>
                      </td>
                      <td class="rating-cell col-rating">
                        <span class={`rating-badge rating-${hero.ratings?.pvp?.toLowerCase() || 'na'}`}>
                          {hero.ratings?.pvp || 'N/A'}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

      <Footer />
    </div>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        font-family: "Spectral", "Roboto", system-ui, sans-serif;
        background:
          radial-gradient(ellipse at 30% -10%, rgba(120,90,200,0.15), transparent 60%),
          radial-gradient(ellipse at 80% 20%, rgba(255,215,100,0.08), transparent 55%),
          linear-gradient(to bottom, #0d0b10, #07060c);
        color: #e6e6eb;
      }

      .page-wrapper {
        margin-left: 96px;
      }

      .hero-header {
        height: 360px;
        background-image: url("/bg.jpg");
        background-size: cover;
        background-position: center 150%;
        background-attachment: fixed;
        position: relative;
      }

      .hero-header::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,0.35)),
          linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.45));
      }

      .title {
        text-align: center;
        margin: 32px 0;
        font-weight: 600;
        font-size: 2.5rem;
      }

      .content-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 16px;
      }

      .filters {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 24px;
        background: linear-gradient(to bottom, rgba(35, 32, 48, 0.85), rgba(18, 16, 26, 0.95));
        backdrop-filter: blur(14px);
        padding: 18px 28px;
        border-radius: 18px;
        box-shadow:
          inset 0 1px 0 rgba(255,255,255,0.08),
          inset 0 -1px 0 rgba(0,0,0,0.6),
          0 20px 50px rgba(0,0,0,0.75);
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
      }

      .filter-label {
        font-weight: 600;
        opacity: 0.85;
      }

      .search-input {
        min-width: 280px;
        height: 32px;
        padding: 6px 10px;
        border-radius: 6px;
        color: #fff;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.2);
      }

      .chip {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.15s;
      }

      .chip:hover {
        opacity: 1;
        transform: translateY(-1px);
      }

      .chip.active { opacity: 1; }

      .class-chip img, .role-chip img {
        width: 36px;
        height: 36px;
        filter: grayscale(100%) brightness(1.2);
      }

      .class-chip.active img, .role-chip.active img {
        filter: brightness(1.4);
      }

      .rarity-star {
        width: 28px;
        height: 28px;
        fill: none;
        stroke: currentColor;
        stroke-width: 1.2;
        transition: fill 0.2s ease, filter 0.2s ease, transform 0.15s ease;
      }

      .rarity-chip.common { color: #4ade80; }
      .rarity-chip.epic { color: #a855f7; }
      .rarity-chip.legendary { color: #facc15; }

      .rarity-chip.active .rarity-star {
        fill: currentColor;
        opacity: 1;
        filter: drop-shadow(0 0 6px currentColor) drop-shadow(0 0 12px rgba(255,255,255,0.15));
      }

      .rarity-chip:hover .rarity-star {
        fill: currentColor;
        opacity: 0.4;
      }

      .reset-button {
        height: 36px;
        padding: 0 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 500;
        color: #e6e6eb;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 999px;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
      }

      .reset-button:hover {
        background: rgba(255, 255, 255, 0.14);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-1px);
      }

      .hero-counter {
        margin: 24px 0 16px;
        text-align: center;
        font-size: 1.125rem;
      }

      /* ── TABLE WRAPPER ─────────────────────────────── */
      .table-wrapper {
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: visible; /* nur für border-radius */
      }

      /* STICKY HEADER — kein overflow-Container darüber */
      .table-header-sticky {
        position: sticky;
        top: 0;
        z-index: 20;
        overflow-x: hidden; /* Header scrollt mit JS synchronisiert */
        background: #1a1720;
      }

      /* SCROLLBARER BODY */
      .table-scroll {
        overflow-x: auto;
      }

      /* BEIDE Tabellen teilen dieselben Spaltenbreiten */
      .tier-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      /* Spaltenbreiten — in beiden Tabellen identisch */
      .col-hero   { width: 260px; }
      .col-rating { width: 120px; }

      /* HEADER TH */
      .tier-table--header thead th {
        background: #1a1720;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.15);
      }

      .tier-table--header thead th.sortable {
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
      }

      .tier-table--header thead th.sortable:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      /* BODY */
      .tier-table--body {
        background: rgba(0, 0, 0, 0.2);
      }

      /* SORT INDICATOR */
      .sort-indicator {
        display: inline-block;
        margin-left: 8px;
        opacity: 0.3;
      }

      .sort-indicator::after { content: "⇅"; }

      th.sort-asc .sort-indicator::after {
        content: "↑";
        opacity: 1;
        color: #facc15;
      }

      th.sort-desc .sort-indicator::after {
        content: "↓";
        opacity: 1;
        color: #facc15;
      }

      .hero-row {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
      }

      .hero-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .hero-cell {
        padding: 12px;
      }

      .hero-link {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: inherit;
        transition: color 0.2s ease;
      }

      .hero-link:hover { color: #facc15; }

      .hero-avatar {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .hero-name {
        font-weight: 500;
        font-size: 1rem;
      }

      .rating-cell {
        padding: 12px;
        text-align: center;
      }

      .rating-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.95rem;
        min-width: 50px;
        text-align: center;
      }

      .rating-sss {
        background: linear-gradient(135deg, #ff6b6b, #ff8787);
        color: #fff;
        box-shadow: 0 0 12px rgba(255, 107, 107, 0.4);
      }

      .rating-ss {
        background: linear-gradient(135deg, #ffd93d, #ffe66d);
        color: #1a1a1a;
        box-shadow: 0 0 12px rgba(255, 217, 61, 0.4);
      }

      .rating-s {
        background: linear-gradient(135deg, #a8e6cf, #c4f0d9);
        color: #1a1a1a;
        box-shadow: 0 0 12px rgba(168, 230, 207, 0.4);
      }

      .rating-a {
        background: linear-gradient(135deg, #74b9ff, #a29bfe);
        color: #fff;
      }

      .rating-b {
        background: linear-gradient(135deg, #dfe6e9, #b2bec3);
        color: #2d3436;
      }

      .rating-c {
        background: linear-gradient(135deg, #636e72, #7f8c8d);
        color: #fff;
      }

      .rating-na {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(230, 230, 235, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* RARITY BORDERS */
      [data-rarity="common"] .hero-avatar    { border-color: rgba(74, 222, 128, 0.55); }
      [data-rarity="epic"] .hero-avatar      { border-color: rgba(168, 85, 247, 0.6); }
      [data-rarity="legendary"] .hero-avatar { border-color: rgba(250, 204, 21, 0.75); }

      .hero-row {
        position: relative;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
      }

      [data-rarity="legendary"].hero-row::before { opacity: 0.3; }
      [data-rarity="legendary"].hero-row:hover::before { opacity: 0.8; }
      .hero-row:hover::before { opacity: 1; }

      .hero-row:hover .hero-avatar          { box-shadow: 0 0 16px currentColor; transform: scale(1.05); }
      [data-rarity="common"]:hover .hero-avatar    { box-shadow: 0 0 16px rgba(74, 222, 128, 0.6); }
      [data-rarity="epic"]:hover .hero-avatar      { box-shadow: 0 0 16px rgba(168, 85, 247, 0.6); }
      [data-rarity="legendary"]:hover .hero-avatar { box-shadow: 0 0 20px rgba(250, 204, 21, 0.8); }

      /* RESPONSIVE */
      @media (max-width: 768px) {
        .page-wrapper   { margin-left: 0; margin-bottom: 64px; }
        .title          { font-size: 1.75rem; }
        .tier-table     { font-size: 0.875rem; }
        .col-hero       { width: 180px; }
        .col-rating     { width: 80px; }

        .tier-table--header thead th {
          padding: 10px 8px;
          font-size: 0.85rem;
        }

        .hero-avatar    { width: 40px; height: 40px; }
        .rating-badge   { padding: 4px 10px; font-size: 0.85rem; min-width: 40px; }
      }
    </style>

    <script>
      const TIER_ORDER: Record<string, number> = {
        'SSS': 7, 'SS': 6, 'S': 5, 'A': 4, 'B': 3, 'C': 2, 'N/A': 1
      };

      document.addEventListener("DOMContentLoaded", () => {
        const searchInput    = document.getElementById("searchInput") as HTMLInputElement;
        const resetButton    = document.getElementById("resetFilters") as HTMLButtonElement;
        const heroCounter    = document.getElementById("heroCounter") as HTMLParagraphElement;
        const tableBody      = document.getElementById("tierTableBody") as HTMLTableSectionElement;
        const headerScroll   = document.querySelector(".table-header-sticky") as HTMLElement;
        const bodyScroll     = document.querySelector(".table-scroll") as HTMLElement;

        const roleChips      = document.querySelectorAll(".role-chip");
        const classChips     = document.querySelectorAll(".class-chip");
        const rarityChips    = document.querySelectorAll(".rarity-chip");
        const factionChips   = document.querySelectorAll(".faction-chip");
        const sortableHeaders = document.querySelectorAll(".sortable");

        // Horizontales Scroll-Sync: Body scrollt → Header folgt
        bodyScroll?.addEventListener("scroll", () => {
          if (headerScroll) headerScroll.scrollLeft = bodyScroll.scrollLeft;
        });

        let activeRoles    = new Set<string>();
        let activeClasses  = new Set<string>();
        let activeRarities = new Set<string>();
        let activeFactions = new Set<string>(); 
        let currentSort    = { column: 'name', direction: 'asc' };

        function applyFilters() {
          const query = (searchInput?.value || "").toLowerCase();
          const rows  = tableBody.querySelectorAll(".hero-row") as NodeListOf<HTMLTableRowElement>;
          let visible = 0;

          rows.forEach(row => {
            const name   = row.dataset.name   || '';
            const cls    = row.dataset.class  || '';
            const role   = row.dataset.role   || '';
            const rarity = row.dataset.rarity || '';
            const faction = row.dataset.faction || '';

            const show =
              (!query || name.includes(query) || cls.includes(query) || faction.includes(query) || role.includes(query)) &&
              (activeClasses.size  === 0 || activeClasses.has(cls))   &&
              (activeRoles.size    === 0 || activeRoles.has(role))     &&
              (activeFactions.size === 0 || activeFactions.has(faction)) &&
              (activeRarities.size === 0 || activeRarities.has(rarity));

            row.style.display = show ? "" : "none";
            if (show) visible++;
          });

          if (heroCounter) {
            heroCounter.textContent = visible === 1 ? "1 Hero shown" : `${visible} Heroes shown`;
          }
        }

        function sortTable(column: string) {
          const rows = Array.from(tableBody.querySelectorAll(".hero-row")) as HTMLTableRowElement[];

          if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.column    = column;
            currentSort.direction = 'asc';
          }

          rows.sort((a, b) => {
            if (column === 'name') {
              const aVal = a.dataset.name || '';
              const bVal = b.dataset.name || '';
              return currentSort.direction === 'asc'
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
            } else {
              const dataKey = column.toLowerCase().replace(/([A-Z])/g, m => m.toLowerCase());
              const aVal = TIER_ORDER[(a.dataset[dataKey] as string)?.toUpperCase() || 'N/A'] || 0;
              const bVal = TIER_ORDER[(b.dataset[dataKey] as string)?.toUpperCase() || 'N/A'] || 0;
              return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            }
          });

          rows.forEach(row => tableBody.appendChild(row));

          sortableHeaders.forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.getAttribute('data-sort') === column) {
              th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
          });

          applyFilters();
        }

        searchInput?.addEventListener("input", applyFilters);

        classChips.forEach(chip => {
          chip.addEventListener("click", () => {
            const c = (chip as HTMLElement).dataset.class || '';
            chip.classList.toggle("active");
            activeClasses.has(c) ? activeClasses.delete(c) : activeClasses.add(c);
            applyFilters();
          });
        });

        roleChips.forEach(chip => {
          chip.addEventListener("click", () => {
            const r = (chip as HTMLElement).dataset.role || '';
            chip.classList.toggle("active");
            activeRoles.has(r) ? activeRoles.delete(r) : activeRoles.add(r);
            applyFilters();
          });
        });

        factionChips.forEach(chip => {
          chip.addEventListener("click", () => {
            const c = (chip as HTMLElement).dataset.faction || '';
            chip.classList.toggle("active");
            activeFactions.has(c) ? activeFactions.delete(c) : activeFactions.add(c);
            applyFilters();
          });
        });

        rarityChips.forEach(chip => {
          chip.addEventListener("click", () => {
            const r = (chip as HTMLElement).dataset.rarity || '';
            chip.classList.toggle("active");
            activeRarities.has(r) ? activeRarities.delete(r) : activeRarities.add(r);
            applyFilters();
          });
        });

        sortableHeaders.forEach(th => {
          th.addEventListener("click", () => {
            const column = th.getAttribute('data-sort');
            if (column) sortTable(column);
          });
        });

        resetButton?.addEventListener("click", () => {
          if (searchInput) searchInput.value = "";
          activeClasses.clear();
          activeRarities.clear();
          activeRoles.clear();
          activeFactions.clear();
          document.querySelectorAll(".chip.active").forEach(c => c.classList.remove("active"));
          sortTable('name');
        });

        applyFilters();
      });
    </script>
    
  </body>
</html>