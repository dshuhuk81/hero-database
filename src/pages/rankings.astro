---
import Sidebar from "../components/Sidebar.astro";
import Footer from "../components/Footer.astro";
import { heroes } from "../data/heroes";
import { computeScore } from "../utils/rankingScore.js";

const rows = [...heroes]
  .map((hero) => {
    const s = hero.stats ?? {};

    const score = computeScore(hero);

    return {
      hero,
      score,
      hp: Number(s.hp ?? 0),
      atk: Number(s.atk ?? 0),
      armor: Number(s.armor ?? 0),
      magicRes: Number(s.magicRes ?? 0),
    };
  })
  .sort((a, b) => b.score - a.score);

---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rankings - Hero Database</title>
  </head>

  <body>
    <Sidebar />

    <!-- Maintenance Alert Dialog -->
    <div id="maintenanceAlert" class="maintenance-alert-overlay">
      <div class="maintenance-alert">
        <div class="maintenance-alert-header">
          <h2>⚠️ Under Maintenance</h2>
          <button class="close-btn" id="closeMaintenanceAlert" aria-label="Close alert">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="maintenance-alert-content">
          <p>This site is currently under maintenance. Some features are being improved for a better experience.</p>
          <ul>
            <li>Synergy score calculation</li>
            <li>Additional ranking metrics</li>
            <li>Performance optimizations</li>
          </ul>
          <p style="margin-top: 1.5rem; font-size: 0.95rem; opacity: 0.9;">We appreciate your patience as we work on these improvements!</p>
        </div>
      </div>
    </div>

    <div class="page-wrapper">
      <h1 class="title">Hero Rankings</h1>

      <div class="content-wrapper">
        <div class="resultcontent">
          <p id="heroCounter" class="hero-counter">0 Heroes shown</p>
          
          <div class="info-box">
            <h3>ℹ️ About This Analysis</h3>
            <p>
              <strong>Primary Reference:</strong> Check the <a href="/tierlist/" style="color: #facc15; text-decoration: none; border-bottom: 1px dashed #facc15;">Tier List</a> for gameplay-based rankings (S, SS, SSS).
            </p>
            <p>
              <strong>This Page:</strong> Automated technical analysis based on hero stats, skill mechanics, and team synergies.
            </p>
            <p style="font-size: 0.9rem; opacity: 0.75;">
              Remember: Automation captures mechanics, not meta-shifts, matchups, or role-specific utility. Always verify with tier list!
            </p>
          </div>

          <p class="subtitle" style="margin-top: 0;">
            Technical scores: 55% Stats + 30% Skills + 15% Synergies
          </p>

          <div class="table-wrapper">

            <!-- STICKY HEADER -->
            <div class="table-header-sticky">
              <table class="tier-table tier-table--header">
                <thead>
                  <tr>
                    <th class="sortable col-rank" data-sort="rank">
                      # <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-hero" data-sort="name">
                      Hero <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-rating" data-sort="tier">
                      Tier <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-rating" data-sort="synergy">
                    Synergy <span class="sort-indicator"></span>
                  </th>
                    <th class="sortable col-score" data-sort="score">
                      Score <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-stat" data-sort="atk">
                      ATK <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-stat" data-sort="hp">
                      HP <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-stat" data-sort="armor">
                      Armor <span class="sort-indicator"></span>
                    </th>
                    <th class="sortable col-stat" data-sort="magicres">
                      M-Res <span class="sort-indicator"></span>
                    </th>
                  </tr>
                </thead>
              </table>
            </div>

            <!-- SCROLLBARER BODY -->
            <div class="table-scroll">
              <table class="tier-table tier-table--body" id="rankingsTable">
                <tbody id="rankingsTableBody">
                  {rows.map((r, idx) => (
                    <tr
                      class="hero-row"
                      data-rank={`${idx + 1}`}
                      data-name={r.hero.name.toLowerCase()}
                      data-class={r.hero.class.toLowerCase()}
                      data-role={r.hero.role.toLowerCase()}
                      data-rarity={r.hero.rarity.toLowerCase()}
                      data-faction={r.hero.faction.toLowerCase()}
                      data-evolution={(r.hero.evolution ?? "unknown").toLowerCase()}
                      data-tier={(r.hero.ratings?.overall ?? "N/A").toUpperCase()}
                      data-synergy={String(r.hero.synergyPotential ?? 0)}
                      data-score={r.score.toFixed(6)}
                      data-hp={r.hp}
                      data-atk={r.atk}
                      data-armor={r.armor}
                      data-magicres={r.magicRes}
                    >
                      <td class="rank-cell col-rank">{idx + 1}</td>

                      <td class="hero-cell col-hero">
                        <a href={`/heroes/${r.hero.id}`} class="hero-link">
                          <img src={r.hero.image} alt={r.hero.name} class="hero-avatar" />
                          <span class="hero-name">{r.hero.name}</span>
                          <img class="factions-icon" src={`/icons/classes/${r.hero.class.toLowerCase()}.webp`} />
                          <img class="factions-icon" src={`/icons/factions/${r.hero.faction.toLowerCase()}.webp`} />
                        </a>
                      </td>

                      <td class="rating-cell col-rating">
                        <span class={`rating-badge rating-${(r.hero.ratings?.overall ?? 'na').toLowerCase()}`}>{r.hero.ratings?.overall ?? 'N/A'}</span>
                      </td>

                      <td class="rating-cell col-rating" title={JSON.stringify(r.hero.synergyTags ?? [])}>
                      <span class="rating-badge rating-na">{r.hero.synergyPotential ?? 0}</span>
                    </td>

                      <td class="score-cell col-score">
                        <span class="score-pill">{Math.round(r.score)}</span>
                      </td>

                      <td class="stat-cell col-stat">{r.atk.toLocaleString("en-US")}</td>
                      <td class="stat-cell col-stat">{r.hp.toLocaleString("en-US")}</td>
                      <td class="stat-cell col-stat">{r.armor.toLocaleString("en-US")}</td>
                      <td class="stat-cell col-stat">{r.magicRes.toLocaleString("en-US")}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

      <Footer />
    </div>

    <style>
      .factions-icon{
        height: 16px;
        width: 16px;
      }

      .info-box {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid rgba(250, 204, 21, 0.6);
        padding: 18px 20px;
        margin-bottom: 24px;
        border-radius: 8px;
      }

      .info-box h3 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 1rem;
        color: rgba(250, 204, 21, 0.9);
      }

      .info-box p {
        margin: 8px 0;
        font-size: 0.95rem;
        line-height: 1.5;
        opacity: 0.9;
      }

      .info-box a {
        color: #facc15;
        text-decoration: none;
        border-bottom: 1px dashed #facc15;
        transition: opacity 0.2s;
      }

      .info-box a:hover {
        opacity: 0.8;
      }

      .rating-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.95rem;
        min-width: 50px;
        text-align: center;
      }

      .rating-sss {
        background: linear-gradient(135deg, #ff6b6b, #ff8787);
        color: #fff;
        box-shadow: 0 0 12px rgba(255, 107, 107, 0.4);
      }

      .rating-ss {
        background: linear-gradient(135deg, #ffd93d, #ffe66d);
        color: #1a1a1a;
        box-shadow: 0 0 12px rgba(255, 217, 61, 0.4);
      }

      .rating-s {
        background: linear-gradient(135deg, #a8e6cf, #c4f0d9);
        color: #1a1a1a;
        box-shadow: 0 0 12px rgba(168, 230, 207, 0.4);
      }

      .rating-a {
        background: linear-gradient(135deg, #74b9ff, #a29bfe);
        color: #fff;
      }

      .rating-b {
        background: linear-gradient(135deg, #dfe6e9, #b2bec3);
        color: #2d3436;
      }

      .rating-c {
        background: linear-gradient(135deg, #636e72, #7f8c8d);
        color: #fff;
      }

      .rating-d {
        background: linear-gradient(135deg, #95a5a6, #bdc3c7);
        color: #2d3436;
      }

      .rating-na {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(230, 230, 235, 0.4);
      }

      html, body {
        margin: 0;
        padding: 0;
        font-family: "Spectral", "Roboto", system-ui, sans-serif;
        background:
          radial-gradient(ellipse at 30% -10%, rgba(120,90,200,0.15), transparent 60%),
          radial-gradient(ellipse at 80% 20%, rgba(255,215,100,0.08), transparent 55%),
          linear-gradient(to bottom, #0d0b10, #07060c);
        color: #e6e6eb;
      }

      .page-wrapper {
        margin-left: 96px;
      }

      .title {
        text-align: center;
        margin: 32px 0 10px;
        font-weight: 600;
        font-size: 2.5rem;
      }

      .subtitle {
        margin: 0 0 18px;
        text-align: center;
        opacity: 0.85;
      }

      .rating-cell, .sortable, .stat-cell {
        text-align-last: center;
      }

      .col-hero {
        text-align-last: left!important;
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.18);
        font-weight: 600;
      }

      .content-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 16px;
      }

      .hero-counter {
        margin: 24px 0 10px;
        text-align: center;
        font-size: 1.125rem;
      }

      /* ── TABLE WRAPPER ─────────────────────────────── */
      .table-wrapper {
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: visible;
      }

      .table-header-sticky {
        position: sticky;
        top: 0;
        z-index: 20;
        overflow-x: hidden;
        background: #1a1720;
      }

      .table-scroll {
        overflow-x: auto;
      }

      .tier-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      /* Spaltenbreiten (ähnlich wie tierlist, nur angepasst) */
      .col-rank  { width: 60px; text-align: center; }
      .col-hero  { width: 240px; }
      .col-rating { width: 100px; text-align: center; }
      .col-score { width: 120px; text-align: center; }
      .col-stat  { width: 140px; text-align: right; }

      .tier-table--header thead th {
        background: #1a1720;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.15);
      }

      .tier-table--header thead th.sortable {
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
      }

      .tier-table--header thead th.sortable:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .tier-table--body {
        background: rgba(0, 0, 0, 0.2);
      }

      .sort-indicator {
        display: inline-block;
        margin-left: 8px;
        opacity: 0.3;
      }
      .sort-indicator::after { content: "⇅"; }

      th.sort-asc .sort-indicator::after {
        content: "↑";
        opacity: 1;
        color: #facc15;
      }
      th.sort-desc .sort-indicator::after {
        content: "↓";
        opacity: 1;
        color: #facc15;
      }

      .hero-row {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
      }
      .hero-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .rank-cell {
        padding: 12px;
        text-align: center;
        font-weight: 700;
        opacity: 0.9;
      }

      .hero-cell {
        padding: 12px;
      }

      .hero-link {
        display: flex;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: inherit;
        transition: color 0.2s ease;
      }
      .hero-link:hover { color: #facc15; }

      .hero-avatar {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        object-position: center 20%;
        border: 2px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .hero-name {
        font-weight: 500;
        font-size: 1rem;
      }

      .evo-cell, .score-cell, .stat-cell, .conf-cell {
        padding: 12px;
      }

      .stat-cell { text-align: right; font-variant-numeric: tabular-nums; }

      .evo-pill {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        font-weight: 700;
        font-size: 0.85rem;
        opacity: 0.95;
      }

      .score-pill {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 10px;
        font-weight: 800;
        font-size: 0.95rem;
        background: rgba(250, 204, 21, 0.08);
        border: 1px solid rgba(250, 204, 21, 0.25);
        box-shadow: 0 0 12px rgba(250, 204, 21, 0.08);
      }

      .conf-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: 800;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }

      .conf-measured {
        background: rgba(74, 222, 128, 0.10);
        border: 1px solid rgba(74, 222, 128, 0.35);
        color: rgba(74, 222, 128, 0.95);
      }

      .conf-estimated {
        background: rgba(250, 204, 21, 0.10);
        border: 1px solid rgba(250, 204, 21, 0.35);
        color: rgba(250, 204, 21, 0.95);
      }

      .conf-unknown {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: rgba(230, 230, 235, 0.6);
      }

      /* RARITY BORDERS */
      [data-rarity="common"] .hero-avatar    { border-color: rgba(74, 222, 128, 0.55); }
      [data-rarity="epic"] .hero-avatar      { border-color: rgba(168, 85, 247, 0.6); }
      [data-rarity="legendary"] .hero-avatar { border-color: rgba(250, 204, 21, 0.75); }

      .hero-row:hover .hero-avatar { box-shadow: 0 0 16px currentColor; transform: scale(1.05); }
      [data-rarity="common"]:hover .hero-avatar    { box-shadow: 0 0 16px rgba(74, 222, 128, 0.6); }
      [data-rarity="epic"]:hover .hero-avatar      { box-shadow: 0 0 16px rgba(168, 85, 247, 0.6); }
      [data-rarity="legendary"]:hover .hero-avatar { box-shadow: 0 0 20px rgba(250, 204, 21, 0.8); }

      /* RESPONSIVE */
      @media (max-width: 768px) {
        .page-wrapper { margin-left: 0; margin-bottom: 64px; }
        .title { font-size: 1.75rem; }
        .tier-table { font-size: 0.875rem; }

        .col-hero  { width: 200px; }
        .col-evo   { width: 110px; }
        .col-score { width: 90px; }
        .col-stat  { width: 120px; }
        .col-conf  { width: 100px; }

        .tier-table--header thead th {
          padding: 10px 8px;
          font-size: 0.85rem;
        }

        .hero-avatar { width: 40px; height: 40px; }
        .score-pill { padding: 4px 10px; font-size: 0.85rem; }
      }

      /* Maintenance Alert Dialog */
      .maintenance-alert-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(2px);
      }

      .maintenance-alert {
        background: linear-gradient(135deg, rgba(30, 25, 50, 0.95) 0%, rgba(40, 30, 60, 0.95) 100%);
        border: 2px solid rgba(250, 204, 21, 0.4);
        border-radius: 12px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .maintenance-alert-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(250, 204, 21, 0.2);
      }

      .maintenance-alert-header h2 {
        margin: 0;
        color: #fcd34d;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .close-btn {
        background: none;
        border: none;
        color: #e6e6eb;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s ease;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fcd34d;
      }

      .maintenance-alert-content {
        color: #e6e6eb;
        line-height: 1.6;
      }

      .maintenance-alert-content p {
        margin: 0 0 12px 0;
      }

      .maintenance-alert-content ul {
        margin: 12px 0;
        padding-left: 24px;
        list-style: none;
      }

      .maintenance-alert-content li {
        margin: 8px 0;
        position: relative;
        padding-left: 16px;
      }

      .maintenance-alert-content li::before {
        content: "✓";
        position: absolute;
        left: 0;
        color: #4caf50;
        font-weight: bold;
      }

      .maintenance-alert-overlay.hidden {
        display: none;
      }
    </style>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Maintenance Alert Handler
        const maintenanceAlert = document.getElementById("maintenanceAlert");
        const closeMaintenanceBtn = document.getElementById("closeMaintenanceAlert");

        closeMaintenanceBtn?.addEventListener("click", () => {
          maintenanceAlert.classList.add("hidden");
        });

        // Close on overlay click
        maintenanceAlert?.addEventListener("click", (e) => {
          if (e.target === maintenanceAlert) {
            maintenanceAlert.classList.add("hidden");
          }
        });

        const heroCounter = document.getElementById("heroCounter");
        const tableBody = document.getElementById("rankingsTableBody");
        const headerScroll = document.querySelector(".table-header-sticky");
        const bodyScroll = document.querySelector(".table-scroll");
        const sortableHeaders = document.querySelectorAll(".sortable");

        // Horizontales Scroll-Sync: Body scrollt → Header folgt
        bodyScroll?.addEventListener("scroll", () => {
          if (headerScroll) headerScroll.scrollLeft = bodyScroll.scrollLeft;
        });

        let currentSort = { column: "score", direction: "desc" };

        function updateCounter() {
          const rows = Array.from(tableBody.querySelectorAll(".hero-row"));
          const visible = rows.filter(r => r.style.display !== "none").length;
          heroCounter.textContent = visible === 1 ? "1 Hero shown" : `${visible} Heroes shown`;
        }

        function sortTable(column, forceDirection = null) {
          const rows = Array.from(tableBody.querySelectorAll(".hero-row"));

          if (forceDirection) {
            currentSort.column = column;
            currentSort.direction = forceDirection;
          } else {
            if (currentSort.column === column) {
              currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
            } else {
              currentSort.column = column;
              currentSort.direction = column === "name" ? "asc" : "desc";
            }
          }

          rows.sort((a, b) => {
            const key = column.toLowerCase();

            if (key === "name") {
              const aVal = a.dataset.name || "";
              const bVal = b.dataset.name || "";
              return currentSort.direction === "asc"
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
            }

            // numeric columns
            const aNum = Number(a.dataset[key] ?? 0);
            const bNum = Number(b.dataset[key] ?? 0);

            return currentSort.direction === "asc" ? (aNum - bNum) : (bNum - aNum);
          });

          rows.forEach(row => tableBody.appendChild(row));

          sortableHeaders.forEach(th => {
            th.classList.remove("sort-asc", "sort-desc");
            if (th.getAttribute("data-sort") === column) {
              th.classList.add(currentSort.direction === "asc" ? "sort-asc" : "sort-desc");
            }
          });

          updateCounter();
        }

        sortableHeaders.forEach(th => {
          th.addEventListener("click", () => {
            const column = th.getAttribute("data-sort");
            if (column) sortTable(column);
          });
        });

        // Default sort
        sortTable("score", "desc");
        updateCounter();
      });
    </script>

  </body>
</html>