---
import teamCompsByHeroId from "../data/derived/teamCompsByHeroId.json";
import { getHeroById } from "../data/heroes";

const { heroId, badgeStyle = "neutral" } = Astro.props; // "neutral" | "colored"
const comps = teamCompsByHeroId?.[heroId] ?? [];

function hero(hid) { return getHeroById(hid); }
function heroName(hid) { return hero(hid)?.name ?? hid; }
function heroImg(hid) {
  const img = hero(hid)?.image;
  if (typeof img !== "string" || img.length === 0) return "";

  // Ensure absolute path from site root
  return img.startsWith("/") ? img : `/${img}`;
}



function heroTags(comp, hid) {
  // bevorzugt summary (neu)
  const fromSummary = comp?.summary?.heroes?.find(x => x.id === hid)?.tags;
  return Array.isArray(fromSummary) ? fromSummary : [];
}

function badgeClass(label) {
  if (badgeStyle !== "colored") return "badge";

  // farbige Kategorien (nur UI, keine Meta)
  const map = {
    "Heal": "badge heal",
    "Shield": "badge shield",
    "Cleanse": "badge cleanse",
    "Control": "badge control",
    "AoE": "badge aoe",
    "Energy": "badge energy",
    "Cooldown": "badge cooldown",
    "Backline": "badge backline",
    "Def Shred": "badge shred",
  };
  return map[label] ?? "badge";
}
---

<section class="comp-card">
  <div class="top">
    <h3>Compositions</h3>

    <!-- optional: local toggle UI -->
    <!--
    <div class="toggle-hint">
      Badges: <strong>{badgeStyle}</strong>
    </div>
    -->
  </div>

  {comps.length === 0 ? (
    <p>No compositions generated yet. Run <code>node scripts/generator.js</code>.</p>
  ) : (
    <div class="comp-list">
      {comps.map((c, idx) => (
        <article class="comp">
          <div class="header">
            <strong>Team #{idx + 1}</strong>
            <small>Ranking (internal): {c.rankingScore}</small>
          </div>

          <div class="bonus">
            {c.summary?.factionBonusPct != null ? (
              <span class="pill">Faction Bonus: {c.summary.factionBonusPct}% ATK & HP</span>
            ) : (
              <span class="pill">Faction Bonus: (see sources)</span>
            )}
          </div>

          <!-- Formation 2 + 3 -->
          <div class="team">
            <div class="row">
              <div class="row-label">Front (2)</div>
              <div class="grid grid-2">
                {c.formation.front.map((hid) => {
                const h = hero(hid);
                const rating =
                    h?.rating
                    ?? h?.ratings?.overall
                    ?? null;

                return (
                    <a
                    class="mini-hero-card"
                    href={`/heroes/${hid}`}
                    style={`--hero-image: url(${heroImg(hid)});`}
                    title={heroName(hid)}
                    >
                    {rating && (
                        <div class={`rating-badge rating-${String(rating).toLowerCase()}`}>
                        {rating}
                        </div>
                    )}

                    <div class="badge-stack">
                        {heroTags(c, hid).map(t => <span class={badgeClass(t)}>{t}</span>)}
                    </div>

                    <div class="name-overlay">
                        <span class="hero-name">{heroName(hid)}</span>
                    </div>
                    </a>
                );
                })}

              </div>
            </div>

            <div class="row">
              <div class="row-label">Back (3)</div>
              <div class="grid grid-3">
                {c.formation.back.map((hid) => {
                    const h = hero(hid);
                    const rating =
                        h?.rating
                        ?? h?.ratings?.overall
                        ?? null;

                    return (
                        <a
                        class="mini-hero-card"
                        href={`/heroes/${hid}`}
                        style={`--hero-image: url(${heroImg(hid)});`}
                        title={heroName(hid)}
                        >
                        {rating && (
                            <div class={`rating-badge rating-${String(rating).toLowerCase()}`}>
                            {rating}
                            </div>
                        )}

                        <div class="badge-stack">
                            {heroTags(c, hid).map(t => <span class={badgeClass(t)}>{t}</span>)}
                        </div>

                        <div class="name-overlay">
                            <span class="hero-name">{heroName(hid)}</span>
                        </div>
                        </a>
                    );
                    })}

              </div>
            </div>
          </div>

          <!-- Sources (facts-only) -->
          <details class="sources">
            <summary>Show sources (facts)</summary>
            <ul class="facts">
              {c.facts.map((f) => (
                <li><strong>{f.title}:</strong> {f.value}</li>
              ))}
            </ul>
          </details>
        </article>
      ))}
    </div>
  )}
</section>

<style>
  .comp-card { padding: 1rem; border: 1px solid rgba(255,255,255,.12); border-radius: 14px; }
  .top { display:flex; justify-content:space-between; align-items:baseline; gap:1rem; }
  .comp-list { display: grid; gap: 1rem; margin-top: .75rem; }
  .comp { padding: 1rem; border: 1px solid rgba(255,255,255,.08); border-radius: 12px; background: rgba(0,0,0,.18); }
  .header { display:flex; justify-content: space-between; gap: 1rem; align-items: baseline; }

  .bonus { margin-top: .5rem; }
  .pill {
    display:inline-block;
    padding:.35rem .6rem;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-size:.85rem;
    opacity:.95;
  }
.mini-hero-card {
  display: block;
  width: 100%;
  height: 140px;
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  background: #222;
  color: #fff;
  text-decoration: none;
  border: 1px solid rgba(255,255,255,.10);
}

.mini-hero-card::before {
  content: "";
  position: absolute;
  inset: 0;
  background-image: var(--hero-image);
  background-size: cover;
  background-position: center 25%;
  transition: transform 0.45s cubic-bezier(.2,.8,.2,1),
              background-position 0.45s cubic-bezier(.2,.8,.2,1);
  will-change: transform;
  z-index: 0;
}

.mini-hero-card:hover::before {
  transform: scale(1.12);
  background-position: center 35%;
}

.mini-hero-card > * { position: absolute; z-index: 2; }

.name-overlay {
  bottom: 0; left: 0; right: 0;
  padding: 8px 8px;
  text-align: center;
  background: linear-gradient(to top, rgba(10,10,16,0.9), rgba(10,10,16,0.55), rgba(10,10,16,0.10));
  backdrop-filter: blur(14px) saturate(1.2);
}

.hero-name { font-size: .85rem; font-weight: 600; letter-spacing: .3px; }

.badge-stack {
  top: 8px; left: 8px; right: 48px;
  display:flex; flex-wrap:wrap; gap:.35rem;
}

  .team { margin-top: .9rem; display:grid; gap: 1rem; }
  .row { display:grid; gap:.5rem; }
  .row-label { font-weight:700; opacity:.9; }

  .grid { display:grid; gap:.75rem; }
  .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

  
  /* Neutral badges */
  .badge {
    padding: .18rem .45rem;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    font-size: .75rem;
    opacity: .95;
  }

  /* Colored badges (same markup, different classes) */
  .badge.heal { background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.35); }
  .badge.shield { background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.35); }
  .badge.cleanse { background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.32); }
  .badge.control { background: rgba(168,85,247,.18); border-color: rgba(168,85,247,.35); }
  .badge.aoe { background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.35); }
  .badge.energy { background: rgba(250,204,21,.18); border-color: rgba(250,204,21,.35); }
  .badge.cooldown { background: rgba(99,102,241,.18); border-color: rgba(99,102,241,.35); }
  .badge.backline { background: rgba(244,63,94,.18); border-color: rgba(244,63,94,.35); }
  .badge.shred { background: rgba(148,163,184,.18); border-color: rgba(148,163,184,.35); }

  .sources { margin-top: .85rem; }
  .facts { margin-top: .5rem; padding-left: 1.25rem; }
</style>
